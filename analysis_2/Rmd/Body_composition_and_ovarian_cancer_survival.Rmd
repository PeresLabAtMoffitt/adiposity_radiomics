---
title: "Body composition and ovarian cancer survival in Moffitt/Roswell patients"
author: "Christelle Colin-Leitzinger"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: united
    highlight: pygments
    df_print: kable
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      fig.align='center'
                      )
```

```{r library, echo = FALSE}
library(tidyverse)
library(labelled)
library(gtsummary)
library(gt)
library(ggcorrplot)
library(ggridges)
library(survminer)
library(survival)
theme_gtsummary_compact()
theme_set(theme_classic())
```

<style>
div.blue { background-color:#0099CC; border-radius: 5px; padding: 20px; font-size: 38px}
</style>
<div class = "blue">

<span style="color: white;">Overall analysis</span>

</div>
<br>

```{r load}
# The repository is saved here 
# Peres_Research/Ovarian - Radiomics/CTbased adiposity/R christelle/adiposity_radiomics
path <- fs::path("","Volumes","Peres_Research", "Ovarian - Radiomics")
# combined_mr_data <- read_rds(paste0(here::here(), 
#                                  "/data/processed_data/first_analysis",
#                                  "/combined Moffitt-Roswell body comp data_2025-04-30.rds"))

# Moffitt
###_______________________ custom function _______________________###
fct_name_repair <- function(colnms) {
  tolower(gsub("[, ()=/]", "_", colnms))
}
###_______________________________________________________________###
body_comp <-
  readxl::read_xlsx(paste0(#path, "/CTbased adiposity/dataset", 
                           here::here(), "/data/raw_data",
                           "/CT data 09272021.xlsx"),
                    .name_repair = fct_name_repair) %>% 
  `colnames<-`(str_replace(colnames(.), "__", "_"))
# clinical_data <-
#   read_csv(paste0(path, "/CTbased adiposity",
#                   "/dataset/ForDan_clinical_modif_06092022.csv"))
updated_survival <- 
  read_rds(paste0(#path, "/Grant applications/Miles for Moffitt/data/processed data",
                  here::here(), "/data/raw_data",
                  "/Ovarian_Normalized_Radiomics_Features_30Apr2025.rds")) %>% 
  `colnames<-`(str_replace(colnames(.), "__", "_"))

# Roswell
roswell_data <-
  readxl::read_xlsx(paste0(here::here(), "/data/raw_data",
                           # path, "/Roswell CTs (May 2024)/Dataset",
                           "/De-ID Data Set for Moffitt 04032024.xlsx"))

# Sigma
# sigma_data <- read_rds(paste0(path,
#                               "/SIGMA/processed data",
#                               "/Sigma_HGSC_patients_data_20260122.rds"))
parent_dir_path <- dirname(here::here())
sigma_data <- read_rds(paste0(parent_dir_path, "/radiomics_sigma",
                                 "/data/processed_data",
                                 "/Sigma_HGSC_patients_data_20260122.rds"))
```

```{r load dafs}
dafs <- read_rds(paste0(here::here(), 
                        "/data/raw_data",
                        # path, "/QICore_DAFs_Analysis/QC Review",
                        "/Ovarian_DAFS_selected_series_19Nov2025.rds")) %>% 
  mutate(across(everything(), ~ str_replace_na(.))) #%>% 
  # janitor::clean_names()

dafs1 <- type.convert(dafs, as.is = TRUE)
```

```{r prepare roswell data}
roswell_data1 <- roswell_data %>% 
  `colnames<-`(str_to_lower(colnames(.)) %>% str_replace(., "ti_1$", "t_index") %>%  str_remove(., "^pre_")) %>% 
  `colnames<-`(str_remove(colnames(.), "_1$")) %>% 
  rename(roswell_id = studyid, 
         age_at_diagnosis = agedx, 
         tumor_site = site,
         stage_clinical = cstage, stage_path = pstage,
         tnm_cs_mixed_group_stage = combined_stage, 
         roswell_grade = grade, roswell_grade_3 = grade_3,
         roswell_lymph_node_status = nodes,
         alcohol_use = alc, smoking_status = tob,
         os_event = survstat,
         ovca_specific_os_event = dsurvstat,
         os_time_from_dx_months = survtime,
         rec_event = recstat, rec_time_from_dx_months = rectime,
                
         roswell_immunotherapy_yes_no = immunotherapy_yes_no,
         roswell_immunotherapy_description = immunotherapy_description,
         
         predx_hypertension = htn, 
         predx_diabetes = diabetes,
         predx_cardiac_conditions = cardiac, 
         predx_hypercholesterolemia = hyperchol,
         predx_hyperlipidemia = hyperlipid,
         predx_chronic_kidney_disease = renal,
         
         height_cm = ht_first, height_m = ht_first_met,
         histolog_cd = histology, histolog_desc = histologydescription,
         hgs_vs_nonhgs = hgs_full_2,
         is_sat_extended = subqout_pre, is_postsat_extended = subqout_post,
         sat = subq,
         imat = ima,
         weight_kg = chemo_start_wgt, chemo_end_weight_kg = chemo_end_wgt,
         debulking = debulk, ascites_volume = ascites_1_num,
         ascites = ascites_1_yes_no
  ) %>% 
  select(-race_2) %>% 
  mutate(race = case_when(
    race == "Unknown"              ~ NA_character_,
    TRUE                           ~ race
  )) %>% 
  mutate(race_all = str_to_sentence(race)) %>% 
  # All patients are presumed Non-Hispanic
  mutate(ethnicity = "Non-Hispanic") %>% 
  mutate(tnm_cs_mixed_group_stage = case_when(
    tnm_cs_mixed_group_stage == 9                       ~ NA_character_,
    tnm_cs_mixed_group_stage == 1                       ~ "I",
    tnm_cs_mixed_group_stage == 2                       ~ "II",
    tnm_cs_mixed_group_stage == 3                       ~ "III",
    tnm_cs_mixed_group_stage == 4                       ~ "IV",
    TRUE                                                ~ as.character(tnm_cs_mixed_group_stage)
  )) %>% 
  mutate(treatment_type = case_when(
    neo == 0                       ~ "Upfront surgery", 
    neo == 1                       ~ "Upfront chemo"
  )) %>% 
  mutate(rec_event = case_when(
    rec_event == 0                  ~ 0,
    rec_event == 1                  ~ 1,
    rec_event == 2                  ~ 0,
    rec_event == 9                  ~ NA_real_,
    TRUE                            ~ rec_event
  )) %>% 
  mutate(site = "Roswell", .before = 1) %>% 
  mutate(sarcopenia = case_when(
    sarcopenia == 1                                          ~ "Yes",
    sarcopenia == 0                                          ~ "No"
  )) %>% 
  mutate(martin = case_when(
    smi < 41                                                ~ "Sarcopenia",
    TRUE                                                    ~ "No sarcopenia"
  )) %>% 
  mutate(ascites = case_when(
    ascites == 0                    ~ "absence",
    ascites == 1                    ~ "presence"
  )) %>% 
  mutate(debulking = case_when(
    debulking == "SUB"              ~ "Suboptimal",
    debulking == "UNKNOWN"          ~ NA_character_,
    debulking == "OPTIMAL"          ~ "Optimal",
    debulking == "COMPLETE"         ~ "Optimal",
    TRUE                            ~ str_to_sentence(debulking)
  )) %>% 
  mutate(alcohol_use = case_when(
    alcohol_use == "Unknown Usage"                          ~ NA_character_,
    TRUE                                                    ~ alcohol_use
  )) %>% 
  mutate(smoking_status = case_when(
    smoking_status == "Unknown Usage"                          ~ NA_character_,
    TRUE                                                    ~ smoking_status
  )) %>% 
  mutate(predx_chronic_kidney_disease = str_to_sentence(predx_chronic_kidney_disease))
```

```{r prepare moffitt data}
body_comp1 <- body_comp %>% 
  purrr::keep(~!all(is.na(.))) %>%
  mutate(mrn = as.character(mrn)) %>% 
  `colnames<-`(str_remove(colnames(.), "_area_cm2")) %>% 
  mutate(baseline_ct_scan_date = as.Date(baseline_ct_scan_date)) %>% 
  rename(moffitt_id = id, height_cm = height_cms_, height_m = height_m_,
         ascites_severity = ascites,
         sma = muscle) %>% 
  mutate(site = "Moffitt", .before = 1) %>% 
  mutate(weight_kg = case_when(
    weight_unit == "kg" |
      weight_unit == "Kg"                  ~ weight,
    weight_unit == "lbs"                   ~ weight / 2.205
  )) %>% 
  select(-c(weight, weight_unit)) %>% 
  mutate(ascites_severity = case_when(
    is.na(ascites_severity)                ~ "absence",
    str_detect(ascites_severity, 
               "tumor")                    ~ "absence",
    str_detect(ascites_severity, 
               "moderate")                 ~ "moderate",
    str_detect(ascites_severity, 
               "severe")                   ~ "severe",
    str_detect(ascites_severity, 
               "mild")                     ~ "mild"
  )) %>% 
  mutate(ascites = case_when(
    str_detect(ascites_severity, 
               "absence")                  ~ "absence",
    str_detect(ascites_severity, 
               "moderate|severe|mild")     ~ "presence"
  ))

updated_survival1 <- updated_survival %>% 
  rename(debulking = debulking_status, 
         diabetes = diabetes_mellitus, 
         race_all = race_cancer_registry) %>% 
  mutate(mrn = as.character(mrn)) %>% 
  distinct(mrn, .keep_all = TRUE) %>% 
  # Outcome
  mutate(os_time_from_dx_months = round(interval(start = date_of_diagnosis, end = fwdate_most_recent)/
                                   duration(n=1, units = "months"), 2)) %>%
  mutate(pfs_enddate = case_when(
    rec_event == 0 & 
      os_event == 1                      ~ fwdate_most_recent, #only use date of death when death occurred but no recurrence
    TRUE                                 ~ rec_event_date, # use recurrence date for everything else
  )) %>% 
  mutate(pfs_time_from_dx_months = round(interval(start = date_of_diagnosis, end = pfs_enddate)/
                                   duration(n=1, units = "months"), 2)) %>%
  # Date for merging
  mutate(baseline_ct_scan_date = as.Date(baseline_ct_scan_date, format = "%m/%d/%Y")) %>% 
  # clinical
  mutate(tnm_cs_mixed_group_stage = case_when(
    tnm_cs_mixed_group_stage == 1                       ~ "I",
    tnm_cs_mixed_group_stage == 2                       ~ "II",
    tnm_cs_mixed_group_stage == 3                       ~ "III",
    tnm_cs_mixed_group_stage == 4                       ~ "IV",
    TRUE                                                ~ as.character(tnm_cs_mixed_group_stage)
  )) %>% 
  mutate(debulking = case_when(
    debulking == "incomplete records"                    ~ NA_character_,
    str_detect(debulking, "^optimal \\(")                ~ "Optimal",
    str_detect(debulking, "^suboptimal \\(")             ~ "Suboptimal",
    str_detect(debulking, "^complete \\(")               ~ "Optimal"
  )) %>% 
  mutate(race_all = str_to_sentence(race_all)) %>% 
  mutate(race = case_when(
    race_all == "White"       ~ "White",
    race_all == "Black"       ~ "Black",
    race_all == "Unkno"       ~ NA_character_,
    !is.na(race_all)          ~ "Other"
  )) %>% 
  mutate(ethnicity = case_when(
    ethnicity_cancer_registry == "UNKNOWN"               ~ NA_character_,
    ethnicity_cancer_registry == "NON-SPANISH"           ~ "Non-Hispanic",
    !is.na(ethnicity_cancer_registry)                    ~ "Hispanic"
  )) %>% 
  # Remove unnecessary variables
  select(-c(starts_with("nor_"), matches("^f[1-9]")))

moffitt_data <- left_join(body_comp1, updated_survival1, 
                          by=c("mrn", "date_of_diagnosis", "baseline_ct_scan_date")) %>% # keep patient with ct image
  
  purrr::keep(~!all(is.na(.))) %>%
  # Eight patients were excluded due to coverage artifacts
  filter(is.na(should_exclude)) %>% 
  # Eight patients were excluded due to incomplete or missing CT images 
  filter(!is.na(sma)) %>% 
  mutate(mrn = as.character(mrn)) %>% 
  
  # Create variable
  mutate(smi = sma / (height_m * height_m)) %>% 
  mutate(sarcopenia = case_when(
    smi <= 38.73                                            ~ "Yes",
    TRUE                                                    ~ "No"
  )) %>% 
  mutate(martin = case_when(
    smi < 41                                                ~ "Sarcopenia",
    TRUE                                                    ~ "No sarcopenia"
  )) %>% 
  mutate(treatment_type = case_when(
    treatment_type == "upfront neoadjuvant"                 ~ "Upfront chemo",
    treatment_type == "upfront surgery"                     ~ "Upfront surgery",
    TRUE                                                    ~ treatment_type
  )) %>% 
  mutate_at(c("hypertension",
              "diabetes", "hypercholesterolemia",
              "chronic_kidney_disease",
              "cardiac_conditions_including_bu",
              "comment_for_cardiac_comorbidity"), ~ str_to_lower(.)) %>% 
  mutate(predx_hypertension = case_when(
    hypertension == "no"                                        ~ "No",
    str_detect(hypertension, "pre|both")                        ~ "Yes",
    TRUE                                                        ~ NA_character_
  )) %>%
  mutate(predx_diabetes = case_when(
    diabetes == "no"                                            ~ "No",
    str_detect(diabetes, "pre|both")                            ~ "Yes",
    TRUE                                                        ~ NA_character_
  )) %>%
  mutate(predx_hypercholesterolemia = case_when(
    hypercholesterolemia == "no"                                ~ "No",
    str_detect(hypercholesterolemia, "pre|both")                ~ "Yes",
    TRUE                                                        ~ NA_character_
  )) %>%
  mutate(predx_chronic_kidney_disease = case_when(
    chronic_kidney_disease == "no"                              ~ "No",
    str_detect(chronic_kidney_disease, "pre|both")              ~ "Yes",
    TRUE                                                        ~ NA_character_
  )) %>%
  mutate(predx_cardiac_conditions = case_when(
    cardiac_conditions_including_bu == "no"                     ~ "No",
    str_detect(cardiac_conditions_including_bu, "pre|both")     ~ "Yes",
    TRUE                                                        ~ NA_character_
  ))
```

```{r prepare sigma data}
sigma_data1 <- sigma_data %>% 
  mutate(site = "Sigma", .before = 1) %>%
  rename(#race_all = race,
         debulking = debulking_status,
         stage = stage_tnm_cs_mixed_group_desc,
         diabetes = diabetes_mellitus,
         cardiac_conditions_including_bu =
           cardiac_conditions_including_but_not_limited_to_transient_ischemic_attack_tia_myocardial_infarction_mi_cardio_myopathy_and_stroke) %>% 
  mutate(race = case_when(
    race_other == "White"       ~ "White",
    race_other == "Black"       ~ "Black",
    !is.na(race_other)          ~ "Other"
  )) %>% 
  # mutate(debulking = case_when(
  #   str_detect(debulking, "Suboptimal")           ~ "Suboptimal",
  #   str_detect(debulking, "Optimal")              ~ "Optimal",
  #   str_detect(debulking, "complete")             ~ "Optimal",
  # )) %>% 
  mutate(tnm_cs_mixed_group_stage = case_when(
    str_detect(stage, "1")                        ~ "I",
    str_detect(stage, "2")                        ~ "II",
    str_detect(stage, "3")                        ~ "III",
    str_detect(stage, "4")                        ~ "IV"
  )) %>% 
  # mutate(treatment_type = case_when(
  #   treatment_type == "Neoadjuvant"              ~ "upfront chemo",
  #   treatment_type == "Adjuvant"                 ~ "upfront surgery"
  # )) %>% 
  mutate_at(c("hypertension",
              "diabetes", "hypercholesterolemia",
              "chronic_kidney_disease",
              "cardiac_conditions_including_bu",
              "comment_for_cardiac_comorbidity"), ~ str_to_lower(.)) %>% 
  mutate(predx_hypertension = case_when(
    hypertension == "no"                                        ~ "No",
    str_detect(hypertension, "pre|both")                        ~ "Yes",
    TRUE                                                        ~ NA_character_
  )) %>%
  mutate(predx_diabetes = case_when(
    diabetes == "no"                                            ~ "No",
    str_detect(diabetes, "pre|both")                            ~ "Yes",
    TRUE                                                        ~ NA_character_
  )) %>%
  mutate(predx_hypercholesterolemia = case_when(
    hypercholesterolemia == "no"                                ~ "No",
    str_detect(hypercholesterolemia, "pre|both")                ~ "Yes",
    TRUE                                                        ~ NA_character_
  )) %>%
  mutate(predx_chronic_kidney_disease = case_when(
    chronic_kidney_disease == "no"                              ~ "No",
    str_detect(chronic_kidney_disease, "pre|both")              ~ "Yes",
    TRUE                                                        ~ NA_character_
  )) %>%
  mutate(predx_cardiac_conditions = case_when(
    cardiac_conditions_including_bu == "no"                     ~ "No",
    str_detect(cardiac_conditions_including_bu, "pre|both")     ~ "Yes",
    TRUE                                                        ~ NA_character_
  ))
```

```{r join}
set.seed(1234)
clinical_data <- bind_rows(roswell_data1,
                       moffitt_data,
                       sigma_data1) %>% 
  mutate(study_name = paste0(site, "_")) %>%
    mutate(row = row_number()) %>% 
  group_by(row = factor(row, levels = sample(unique(row)))) %>%
  mutate(random_id = cur_group_id()) %>%
  ungroup() %>%
  mutate(zero = 6 - nchar(random_id)) %>%
  mutate(add_zero = stringi::stri_dup("0", zero)) %>%
  select(c(study_name, add_zero, random_id, mrn, everything())) %>%
  unite(deidentified_patient_id, study_name:random_id, sep = "", remove = TRUE) %>% 
  mutate(ct_patient_id = coalesce(mrn, roswell_id)) %>% 
  select(deidentified_patient_id, ct_patient_id,
         everything(), 
         -c(roswell_id, moffitt_id, mrn, zero), 
         roswell_id, moffitt_id, mrn)

clinical_data <- clinical_data %>% 
  mutate(site = case_when(
    site == "Moffitt" |
      site == "Sigma"                        ~ "Moffitt + Sigma",
    TRUE                                     ~ site
  )) %>%
  mutate(year_of_diagnosis = year(date_of_diagnosis)) %>% 
  mutate(year_of_diagnosis_cat = case_when(
    year_of_diagnosis <= 2013                ~ "2013 and earlier",
    year_of_diagnosis > 2013 &
      year_of_diagnosis <= 2019              ~ "2014-2019",
    year_of_diagnosis > 2019                 ~ "2020 and later"
  )) %>% 
  mutate(year_of_diagnosis = as.character(year_of_diagnosis)) %>% 
  mutate(race = factor(race, levels = c("White", "Black", "Other"))) %>%
  mutate(raceeth = case_when(
    ethnicity == "Non-Hispanic" &
      race == "White"                        ~ "Non-Hispanic White",
    ethnicity == "Non-Hispanic" &
      race == "Black"                        ~ "Non-Hispanic Black",
    ethnicity == "Hispanic"                  ~ "Hispanic, any race",
    TRUE                                     ~ paste(race, ethnicity)
  )) %>%
  # mutate(raceeth = factor(raceeth, levels = c("White Non-Hispanic",
  #                                             "Black Non-Hispanic",
  #                                             "Hispanic any race"))) %>%
  mutate(tnm_cs_mixed_group_stage = case_when(
    tnm_cs_mixed_group_stage == "I" |
      tnm_cs_mixed_group_stage == "II"       ~ "I-II",
    TRUE                                     ~ tnm_cs_mixed_group_stage
  ), tnm_cs_mixed_group_stage = factor(tnm_cs_mixed_group_stage, 
                                       levels = c("I-II", "III", "IV"))) %>% 
  mutate(bmi = weight_kg / (height_m * height_m)) %>% 
  mutate(bmi_cat = case_when(
    bmi < 25                    ~ "<25 kg/m²",
    bmi >= 25 &
      bmi < 30                  ~ "25-30 kg/m²",
    bmi >= 30                   ~ "≥30 kg/m²"
  )) %>%
  mutate(bmi_cat = factor(bmi_cat, levels = c("<25 kg/m²", "25-30 kg/m²", "≥30 kg/m²")))
```


# 0. Explore DAFs variables
Details on data at
Peres_Research/Ovarian - Radiomics/QICore_DAFs_Analysis/QC Review/QC Review Summary.docx   
We aggregate data form multiple sites.
```{r feature characteristics}
dafs1 %>%
  select(#phase,
         # selected_series,
         # exclude_flag,
         set
         ) %>%
  tbl_summary(type = everything() ~ "categorical") %>%
  bold_labels() %>%
  modify_header(label ~ "**DAFS**",
                all_stat_cols() ~ "**{level}**, N = {n}")
```

```{r dafs cleaning}
dafs2 <- dafs1
```

## What variables are available?
```{r body comp existing var}
body_comp_type <- colnames(dafs2 %>%
  select("L3mid;SKM[-29,150];cross_sectional_area_pixels":
         "L3mid-avg[3];ASCITES;HU_max"
         )) %>% as_tibble() %>%
  `colnames<-`(c("variable"))

body_comp_type1 <- body_comp_type %>%
  mutate(variable1= str_match(variable, "(.*);(.*);(.*)")[,1]) %>%
  mutate(region = str_match(variable, "(.*);(.*);(.*)")[,2]) %>%
  mutate(feature = str_match(variable, "(.*);(.*);(.*)")[,3]) %>%
  mutate(unit = str_match(variable, "(.*);(.*);(.*)")[,4])

body_comp_type1 %>%
  select(region, feature, unit
         ) %>%
  filter(!is.na(region)) %>%
  tbl_summary() %>%
  bold_labels() %>%
  modify_column_hide(columns = "stat_0")%>%
  modify_header(label ~ "**DAFS data**")

# body_comp_type1 %>%
#   select(region, feature
#          ) %>%
#   filter(!is.na(region)) %>%
#   tbl_summary(by = region) %>%
#   bold_labels()

# show_header_names(a, show_hidden=TRUE)


selected_features <- body_comp_type1 %>%
  filter(
    (str_detect(feature, "NOARMS") & unit == "volume_cm3") | # For skm and imat
    (str_detect(feature, "NOARMS") & unit == "cross_sectional_area_cm2") | # For skm and imat
    (str_detect(feature, "SKM") & str_detect(feature, "NOARMS") & unit == "HU_mean") | # For skm
    (str_detect(feature, c("ASCITES")) & unit == "volume_cm3") | # use cm3 for ascites
    (str_detect(feature, c("ASCITES")) & unit == "cross_sectional_area_cm2") | # to compare
    (feature %in% c("SAT[-190,-30]", "VAT[-150,-50]") & unit == "volume_cm3") |
    (feature %in% c(#"ASCITES",
                    "SAT[-190,-30]", "VAT[-150,-50]") & unit == "cross_sectional_area_cm2") #|
    # (feature %in% c(#"ASCITES",
    #                 "SAT", "VAT") & unit == "hu_mean")
    )
```
Explanation for these tables : 
- there are 3 regions (L3mid, L3mid-avg, L3start-L3end).   
- multiple features for muscle, and adiposity.  
- different units.   
For each region, we have info for each feature combined with each units.   
I found info in this paper https://pmc.ncbi.nlm.nih.gov/articles/PMC7614477/    
Body composition was measured using three exploratory boundaries to estimate muscle and fat distributions at the level of the third lumbar vertebra (L3).    
avg-L3mid, which measures across 3 slices above and below the midst of L3 in order to increase data accuracy.
L3mid: Refers to a measurement taken at a single, specific axial slice at the midpoint of the L3 vertebra.    
L3start-L3end: Refers to a multi-slice or volumetric measurement encompassing the entire length of the L3 vertebra.    
The following Hounsfield unit (HU) boundaries were used: For SAT -190 to -30 HU, for VAT -150 to -50 HU and for SKM -29 to 150 HU.    

So we don't need to use all the variables (for example we don't need anything with units HU_max, HU_median, HU_min, or HU_std).   

Advise from Dan:   
- For muscle HU (Hounsfield unit) use the mean variable which measure radiodensity. It is important in case of oedema, scaring. It is muscle radiomics, it reflect the muscle quality.   
- For TAT and total tissue proportion calculation, use the area cm2 and volume cm3 variables.   
- The best quantification of ascites would be to measure.  
volume of ascites in cm3 between two axial levels such as T12 to L5 or
T12 to sacrum depending on availability within the cohort.   
This involves summing up all the cm3 ascites measurements for each included vertebral body level.   
- Calculate tissue proportion (for variable A, we divide variable A by the addition of all the tissue combined muscle+VAT+SAT+IMAT). In Dan's paper, I found it written as he used the indexed values for the calculation but the results are the same for indexed or not so I used the raw values.   
- Dan also talked about calculating a z-score for each features (1_SD)...

Note:   
The sarcopenia cutoff I used is 38.5.   
1— “The cut-off of SMI introduced by Prado et al. in 2008 (sarcopenia was defined as SMI < 52.4 cm2/m2 for males and SMI < 38.5 cm2/m2 for females) was used in 20 studies covering 10 countries”.   
2— “The cut-off provided by Martin et al. in 2013 (sarcopenia was defined as SMI < 41 cm2/m2 in fe- males; SMI < 53 cm2/m2 if BMI ≥ 25 kg/m2 and SMI < 43 cm2/m2 if BMI < 25 kg/m2 in males) was used in 17 studies covering 9 Asian and non-Asian countries”. We tried using this one previously but didn't seem to fit our data as 41 seems to high cutoff.   
3— “The cut-off introduced by Zhuang et al. was generally used in Asian countries (12 studies: [13, 25, 26, 35, 40, 41, 46, 48, 53, 55, 63, 84]), which defined sarcopenia as SMI < 40.8 cm2/m2 in males and SMI < 34.9 cm2/m2 in females, but the majority of the studies were from the same center.”   
4— “The cut-off provided by Iritani et al. was used in three studies (SMI < 36 cm2/m2 in male; SMI < 29 cm2/m2 in female) with a median prevalence of 9.3% [35, 59, 72], and the cut-off provided by Voron et al. was also used in three studies (SMI < 55 cm2/m2 in male; SMI < 39 cm2/m2 in female) with a median preva- lence of 53.6% [36, 79, 80]. Two other Japanese studies adopted the cut-off from Sakurai et al. (SMI < 43.2 cm2/ m2 in males; SMI < 34.6 cm2/m2 in females) and had a median prevalence of 23.5% [18, 35].”   

https://www.frontiersin.org/journals/endocrinology/articles/10.3389/fendo.2024.1369584/full has a much lower cutoff.   
Another paper on ovarian cancer use optimum stratification to find the optimal skeletal muscle index cutoff to define sarcopenia https://pubmed.ncbi.nlm.nih.gov/28159443/. In their cohort (upfront surgery only), they calculate the cutoff at 38.73 cm2/m2. This is not far from the Prado cutoff. In their previous paper (upfront chemo only), they did a median cutoff at SMI < 41.5.

For each of the 3 region, these are the selected features we use moving forward:
```{r selected_features}
selected_features %>% select(feature : unit) %>% distinct()
```
I cleaned up the names so they are not as long and are more meaningful hereafter.
Just keep in mind I used that ALLSKM_NOARMS, ALLIMAT_NOARMS and the with boundary features for SAT and VAT.

<br>

```{r join with clinical}
data <- dafs2 %>%
  select(ct_PatientID, selected_features$variable) %>%
  janitor::clean_names() %>%
  `colnames<-`(str_replace(colnames(.), "l3mid_avg_3_", "l3midavg_") %>%
                 str_replace(., "cross_sectional_area_cm2", "area_cm2") %>%
                 str_replace(., "ascites_10_10", "ascites_transudative") %>%
                 str_replace(., "ascites_16_2048", "ascites_exudative") %>%
                 str_replace(., "ascites_46_2048", "ascites_hemoperitoneum") %>%
                 str_replace(., "ascites_volume", "ascites_full_volume") %>%
                 str_replace(., "ascites_area", "ascites_full_area") %>%
                 str_replace(., "allskm_29_150_", "skm_") %>%
                 str_replace(., "allimat_190_30_", "imat_") %>%
                 str_replace(., "vat_150_50_", "vat_") %>%
                 str_replace(., "sat_190_30_", "sat_") %>%
                 str_remove(., "_noarms")) %>%
  # slice(1:424) %>%
  inner_join(., clinical_data,
             by = "ct_patient_id")
```

```{r add body comp analysis var}
data <- data %>%
  # Index
  mutate(across(c(ends_with("area_cm2"),
                  ends_with("volume_cm3"),
                  -contains("ascites")), ~ . / (height_m ^2),
                .names = "{.col}_index"), .after = 1) %>%
  # SMI
  rename(l3midavg_smi = l3midavg_skm_area_cm2_index,
         l3mid_smi = l3mid_skm_area_cm2_index,
         l3start_l3end_smi = l3start_l3end_skm_area_cm2_index) %>%

  # Sarcopenia
  mutate(l3midavg_sarcopenia = case_when(
    l3midavg_smi >= 38.5                             ~ "≥38.5",
    !is.na(l3midavg_smi)                             ~ "<38.5 : sarcopenia"
  )) %>%
  mutate(l3mid_sarcopenia = case_when(
    l3mid_smi >= 38.5                                ~ "≥38.5",
    !is.na(l3mid_smi)                                ~ "<38.5 : sarcopenia"
  )) %>%
  mutate(l3start_l3end_sarcopenia = case_when(
    l3start_l3end_smi >= 38.5                        ~ "≥38.5",
    !is.na(l3start_l3end_smi)                        ~ "<38.5 : sarcopenia"
  )) %>%
  # Myosteatosis - skeletal muscle fat infiltration
  mutate(l3midavg_myosteatosis = case_when(
    bmi < 25 &
      l3midavg_skm_hu_mean < 41                      ~ "Myosteatosis",
    bmi >= 25 &
      l3midavg_skm_hu_mean < 33                      ~ "Myosteatosis",
    !is.na(l3midavg_skm_hu_mean) &
      !is.na(bmi)                                    ~ "No myosteatosis"
  )) %>%
  mutate(l3mid_myosteatosis = case_when(
    bmi < 25 &
      l3mid_skm_hu_mean < 41                         ~ "Myosteatosis",
    bmi >= 25 &
      l3mid_skm_hu_mean < 33                         ~ "Myosteatosis",
    !is.na(l3mid_skm_hu_mean) &
      !is.na(bmi)                                    ~ "No myosteatosis"
  )) %>%
  mutate(l3start_l3end_myosteatosis = case_when(
    bmi < 25 &
      l3start_l3end_skm_hu_mean < 41                 ~ "Myosteatosis",
    bmi >= 25 &
      l3start_l3end_skm_hu_mean < 33                 ~ "Myosteatosis",
    !is.na(l3start_l3end_skm_hu_mean) &
      !is.na(bmi)                                    ~ "No myosteatosis"
  )) %>%
  mutate(across(c(ends_with("_myosteatosis")),
                ~ factor(., levels =
                           c("No myosteatosis", "Myosteatosis")))) %>%
  # V/S ratio
  mutate(l3mid_v_s_ratio_cm2 = l3mid_vat_area_cm2 / l3mid_sat_area_cm2) %>%
  mutate(l3midavg_v_s_ratio_cm2 = l3midavg_vat_area_cm2 / l3midavg_sat_area_cm2) %>%
  mutate(l3start_l3end_v_s_ratio_cm2 = l3start_l3end_vat_area_cm2 / l3start_l3end_sat_area_cm2) %>%

  mutate(l3mid_v_s_ratio_cm3 = l3mid_vat_volume_cm3 / l3mid_sat_volume_cm3) %>%
  mutate(l3midavg_v_s_ratio_cm3 = l3midavg_vat_volume_cm3 / l3midavg_sat_volume_cm3) %>%
  mutate(l3start_l3end_v_s_ratio_cm3 = l3start_l3end_vat_volume_cm3 / l3start_l3end_sat_volume_cm3) %>%
  # TAT
  mutate(l3mid_tat_cm2 = case_when(
    is.na(l3mid_vat_area_cm2) |
    is.na(l3mid_sat_area_cm2) |
    is.na(l3mid_imat_area_cm2)                       ~ NA_real_,
    TRUE                                             ~ l3mid_vat_area_cm2 + l3mid_sat_area_cm2 + l3mid_imat_area_cm2
  )) %>%
  mutate(l3midavg_tat_cm2 = case_when(
    is.na(l3midavg_vat_area_cm2) |
    is.na(l3midavg_sat_area_cm2) |
    is.na(l3midavg_imat_area_cm2)                    ~ NA_real_,
    TRUE                                             ~ l3midavg_vat_area_cm2 + l3midavg_sat_area_cm2 + l3midavg_imat_area_cm2
  )) %>%
  mutate(l3start_l3end_tat_cm2 = case_when(
    is.na(l3start_l3end_vat_area_cm2) |
    is.na(l3start_l3end_sat_area_cm2) |
    is.na(l3start_l3end_imat_area_cm2)               ~ NA_real_,
    TRUE                                             ~ l3start_l3end_vat_area_cm2 + l3start_l3end_sat_area_cm2 + l3start_l3end_imat_area_cm2
  )) %>%
  mutate(l3mid_tat_cm3 = case_when(
    is.na(l3mid_vat_volume_cm3) |
    is.na(l3mid_sat_volume_cm3) |
    is.na(l3mid_imat_volume_cm3)                       ~ NA_real_,
    TRUE                                             ~ l3mid_vat_volume_cm3 + l3mid_sat_volume_cm3 + l3mid_imat_volume_cm3
  )) %>%
  mutate(l3midavg_tat_cm3 = case_when(
    is.na(l3midavg_vat_volume_cm3) |
    is.na(l3midavg_sat_volume_cm3) |
    is.na(l3midavg_imat_volume_cm3)                    ~ NA_real_,
    TRUE                                             ~ l3midavg_vat_volume_cm3 + l3midavg_sat_volume_cm3 + l3midavg_imat_volume_cm3
  )) %>%
  mutate(l3start_l3end_tat_cm3 = case_when(
    is.na(l3start_l3end_vat_volume_cm3) |
    is.na(l3start_l3end_sat_volume_cm3) |
    is.na(l3start_l3end_imat_volume_cm3)               ~ NA_real_,
    TRUE                                             ~ l3start_l3end_vat_volume_cm3 + l3start_l3end_sat_volume_cm3 + l3start_l3end_imat_volume_cm3
  )) %>%
  # Proportion - remove the values if one feature is NA
  mutate(l3midavg_muscle_proportion_cm2 = l3midavg_skm_area_cm2 /
           (l3midavg_skm_area_cm2 + l3midavg_vat_area_cm2 +
              l3midavg_sat_area_cm2 + l3midavg_imat_area_cm2)) %>%
  mutate(l3midavg_vat_proportion_cm2 = l3midavg_vat_area_cm2 /
           (l3midavg_skm_area_cm2 + l3midavg_vat_area_cm2 +
              l3midavg_sat_area_cm2 + l3midavg_imat_area_cm2)) %>%
  mutate(l3midavg_sat_proportion_cm2 = l3midavg_sat_area_cm2 /
           (l3midavg_skm_area_cm2 + l3midavg_vat_area_cm2 +
              l3midavg_sat_area_cm2 + l3midavg_imat_area_cm2)) %>%
  mutate(l3midavg_imat_proportion_cm2 = l3midavg_imat_area_cm2 /
           (l3midavg_skm_area_cm2 + l3midavg_vat_area_cm2 +
              l3midavg_sat_area_cm2 + l3midavg_imat_area_cm2)) %>%
  mutate(l3midavg_muscle_proportion_cm3 = l3midavg_skm_volume_cm3 /
           (l3midavg_skm_volume_cm3 + l3midavg_vat_volume_cm3 +
              l3midavg_sat_volume_cm3 + l3midavg_imat_volume_cm3)) %>%
  mutate(l3midavg_vat_proportion_cm3 = l3midavg_vat_volume_cm3 /
           (l3midavg_skm_volume_cm3 + l3midavg_vat_volume_cm3 +
              l3midavg_sat_volume_cm3 + l3midavg_imat_volume_cm3)) %>%
  mutate(l3midavg_sat_proportion_cm3 = l3midavg_sat_volume_cm3 /
           (l3midavg_skm_volume_cm3 + l3midavg_vat_volume_cm3 +
              l3midavg_sat_volume_cm3 + l3midavg_imat_volume_cm3)) %>%
  mutate(l3midavg_imat_proportion_cm3 = l3midavg_imat_volume_cm3 /
           (l3midavg_skm_volume_cm3 + l3midavg_vat_volume_cm3 +
              l3midavg_sat_volume_cm3 + l3midavg_imat_volume_cm3)) %>%
  mutate(across(c(starts_with("(l3midavg_") & contains("_proportion")), ~ case_when(
    is.na(l3midavg_skm_area_cm2) |
    is.na(l3midavg_vat_area_cm2) |
    is.na(l3midavg_sat_area_cm2) |
    is.na(l3midavg_imat_area_cm2)                    ~ NA_real_,
    TRUE                                             ~ .
  ))) %>%

  mutate(l3mid_muscle_proportion_cm2 = l3mid_skm_area_cm2 /
           (l3mid_skm_area_cm2 + l3mid_vat_area_cm2 +
              l3mid_sat_area_cm2 + l3mid_imat_area_cm2)) %>%
  mutate(l3mid_vat_proportion_cm2 = l3mid_vat_area_cm2 /
           (l3mid_skm_area_cm2 + l3mid_vat_area_cm2 +
              l3mid_sat_area_cm2 + l3mid_imat_area_cm2)) %>%
  mutate(l3mid_sat_proportion_cm2 = l3mid_sat_area_cm2 /
           (l3mid_skm_area_cm2 + l3mid_vat_area_cm2 +
              l3mid_sat_area_cm2 + l3mid_imat_area_cm2)) %>%
  mutate(l3mid_imat_proportion_cm2 = l3mid_imat_area_cm2 /
           (l3mid_skm_area_cm2 + l3mid_vat_area_cm2 +
              l3mid_sat_area_cm2 + l3mid_imat_area_cm2)) %>%

   mutate(l3mid_muscle_proportion_cm3 = l3mid_skm_volume_cm3 /
           (l3mid_skm_volume_cm3 + l3mid_vat_volume_cm3 +
              l3mid_sat_volume_cm3 + l3mid_imat_volume_cm3)) %>%
  mutate(l3mid_vat_proportion_cm3 = l3mid_vat_volume_cm3 /
           (l3mid_skm_volume_cm3 + l3mid_vat_volume_cm3 +
              l3mid_sat_volume_cm3 + l3mid_imat_volume_cm3)) %>%
  mutate(l3mid_sat_proportion_cm3 = l3mid_sat_volume_cm3 /
           (l3mid_skm_volume_cm3 + l3mid_vat_volume_cm3 +
              l3mid_sat_volume_cm3 + l3mid_imat_volume_cm3)) %>%
  mutate(l3mid_imat_proportion_cm3 = l3mid_imat_volume_cm3 /
           (l3mid_skm_volume_cm3 + l3mid_vat_volume_cm3 +
              l3mid_sat_volume_cm3 + l3mid_imat_volume_cm3)) %>%
  mutate(across(c(starts_with("(l3mid_") & contains("_proportion")), ~ case_when(
    is.na(l3mid_skm_area_cm2) |
    is.na(l3mid_vat_area_cm2) |
    is.na(l3mid_sat_area_cm2) |
    is.na(l3mid_imat_area_cm2)                       ~ NA_real_,
    TRUE                                             ~ .
  ))) %>%

  mutate(l3start_l3end_muscle_proportion_cm2 = l3start_l3end_skm_area_cm2 /
           (l3start_l3end_skm_area_cm2 + l3start_l3end_vat_area_cm2 +
              l3start_l3end_sat_area_cm2 + l3start_l3end_imat_area_cm2)) %>%
  mutate(l3start_l3end_vat_proportion_cm2 = l3start_l3end_vat_area_cm2 /
           (l3start_l3end_skm_area_cm2 + l3start_l3end_vat_area_cm2 +
              l3start_l3end_sat_area_cm2 + l3start_l3end_imat_area_cm2)) %>%
  mutate(l3start_l3end_sat_proportion_cm2 = l3start_l3end_sat_area_cm2 /
           (l3start_l3end_skm_area_cm2 + l3start_l3end_vat_area_cm2 +
              l3start_l3end_sat_area_cm2 + l3start_l3end_imat_area_cm2)) %>%
  mutate(l3start_l3end_imat_proportion_cm2 = l3start_l3end_imat_area_cm2 /
           (l3start_l3end_skm_area_cm2 + l3start_l3end_vat_area_cm2 +
              l3start_l3end_sat_area_cm2 + l3start_l3end_imat_area_cm2)) %>%

   mutate(l3start_l3end_muscle_proportion_cm3 = l3start_l3end_skm_volume_cm3 /
           (l3start_l3end_skm_volume_cm3 + l3start_l3end_vat_volume_cm3 +
              l3start_l3end_sat_volume_cm3 + l3start_l3end_imat_volume_cm3)) %>%
  mutate(l3start_l3end_vat_proportion_cm3 = l3start_l3end_vat_volume_cm3 /
           (l3start_l3end_skm_volume_cm3 + l3start_l3end_vat_volume_cm3 +
              l3start_l3end_sat_volume_cm3 + l3start_l3end_imat_volume_cm3)) %>%
  mutate(l3start_l3end_sat_proportion_cm3 = l3start_l3end_sat_volume_cm3 /
           (l3start_l3end_skm_volume_cm3 + l3start_l3end_vat_volume_cm3 +
              l3start_l3end_sat_volume_cm3 + l3start_l3end_imat_volume_cm3)) %>%
  mutate(l3start_l3end_imat_proportion_cm3 = l3start_l3end_imat_volume_cm3 /
           (l3start_l3end_skm_volume_cm3 + l3start_l3end_vat_volume_cm3 +
              l3start_l3end_sat_volume_cm3 + l3start_l3end_imat_volume_cm3)) %>%
  mutate(across(c(starts_with("(l3start_l3end_") & contains("_proportion")), ~ case_when(
    is.na(l3start_l3end_skm_area_cm2) |
    is.na(l3start_l3end_vat_area_cm2) |
    is.na(l3start_l3end_sat_area_cm2) |
    is.na(l3start_l3end_imat_area_cm2)               ~ NA_real_,
    TRUE                                             ~ .
  ))) %>% 
  mutate(across(c(ends_with("skm_area_cm2"), ends_with("skm_volume_cm3"),
                  ends_with("vat_area_cm2"), ends_with("vat_volume_cm3"), 
                  ends_with("sat_area_cm2"), ends_with("sat_volume_cm3"),
                  ends_with("imat_area_cm2"), ends_with("imat_volume_cm3"),
                  ends_with("skm_hu_mean"),
                  contains("_smi"), 
                  contains("_index"),
                  contains("_proportion")
                  ), ~ . / sd(., na.rm = TRUE) , .names = "{.col}_sdhr"))
```

```{r make categorical var}
data <- data %>%
  # Make categorical var
  mutate(across(c(starts_with("l3") & ends_with("_smi"),
                  starts_with("l3") & ends_with("_index"),
                  starts_with("l3") & contains("_skm"),
                  starts_with("l3") & contains("_imat"),
                  starts_with("l3") & contains("_sat"),
                  starts_with("l3") & contains("_vat"),
                  starts_with("l3") & contains("_proportion"),
                  starts_with("l3") & contains("_v_s_ratio"),
                  starts_with("l3") & contains("_tat"), 
                  -ends_with("_sdhr")
                  ), ~ case_when(
    ntile(., 3) == 1 ~ "Low",
    ntile(., 3) == 2 ~ "Medium",
    ntile(., 3) == 3 ~ "High"),
    .names = "{.col}_tertcat")) %>%
  mutate(across(c(ends_with("_tertcat")),
                ~ factor(., levels =
                           c("Low", "Medium", "High"))))
```

```{r Labeling data}
var_label(data) <- list(age_at_diagnosis = "Patient age",
                        year_of_diagnosis = "Diagnosis (year)",
                        sex = "Sex",
                        race_all	 = "Race (raw)",
                        race = "Race", ethnicity = "Ethnicity",
                        raceeth = "Race and Ethnicity",
                        debulking = "Debulking status",
                        bmi = "BMI (continuous)",
                        bmi_cat = "BMI (categorical)",
                        weight_kg = "Weight (kg)",
                        height_m = "Height (m)",
                        os_event = "Deaths",

                        # sarcopenia = "Sarcopenia",
                        # myosteatosis = "Myosteatosis",
                        site = "Site"
)
```


# I. Patient characteristics
Notes:    
All Roswell patients are presumed Non-Hispanic

We have some patients with missing race or ethnicity. I filled up the blank as best as I think following this:   
raceeth == "Other Non-Hispanic"             ~ "Non-Hispanic, Other race",   
raceeth == "NA Non-Hispanic"                ~ "Non-Hispanic, Other race",   
raceeth == "White NA"                       ~ "Non-Hispanic White"   

For missing BMI, all Sigma patient are 99 or 999 for height, weight in cancer registry and not abstracted in cerner bmi file.   
For Moffitt patients, all weight are missing because recorded after tx date.   
```{r code raceeth}
data <- data %>%
  mutate(raceeth = case_when(
    raceeth == "Hispanic, any race"             ~ "Hispanic, any race",
    raceeth == "Non-Hispanic Black"             ~ "Non-Hispanic Black",
    raceeth == "Non-Hispanic White"             ~ "Non-Hispanic White",
    raceeth == "Other Non-Hispanic"             ~ "Non-Hispanic, Other race",
    raceeth == "NA Non-Hispanic"                ~ "Non-Hispanic, Other race",
    raceeth == "White NA"                       ~ "Non-Hispanic White"
  ), raceeth = factor(raceeth, levels = c("Non-Hispanic White",
                                          "Non-Hispanic Black",
                                          "Hispanic, any race",
                                          "Non-Hispanic, Other race")))
```

## 1. By site
```{r char by site}
data %>%
  select(site,
         age_at_diagnosis, 
         year_of_diagnosis, year_of_diagnosis_cat,
         raceeth, race, race_all, ethnicity, tnm_cs_mixed_group_stage,
         treatment_type,
         debulking,
         height_m, weight_kg,
         bmi, bmi_cat,
         rec_event, pfs_event, os_event,
         os_time_from_dx_months,
         starts_with("predx_")
         ) %>%
  tbl_summary(by = site,
              type = list(c(rec_event, pfs_event, os_event, 
                            starts_with("predx_")) ~ "categorical")) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall() %>% 
  modify_header(label ~ "**Patient characteristics**",
                all_stat_cols() ~ "**{level}**, N = {n}")
```
<br>

# II. Body composition
## 1. Bodycomp by site
### a. Continuous
```{r table by site}
tbl_midavg <- data %>%
  select(l3midavg_skm_area_cm2, l3midavg_sat_area_cm2, l3midavg_vat_area_cm2, l3midavg_imat_area_cm2,
         l3midavg_skm_volume_cm3, l3midavg_sat_volume_cm3, l3midavg_vat_volume_cm3, l3midavg_imat_volume_cm3,
         l3midavg_skm_hu_mean, l3midavg_myosteatosis,
         l3midavg_v_s_ratio_cm2, l3midavg_v_s_ratio_cm3,
         l3midavg_tat_cm2, l3midavg_tat_cm3,
         site) %>% 
  `colnames<-`(str_remove(colnames(.), "l3midavg_") %>%
                 str_replace(., "v_s", "V/S") %>%
                 str_replace(., "tat", "TAT") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "skm", "Skeleton muscle") %>%
                 str_replace(., "hu_mean", "HU") %>%
                 str_replace(., "myosteatosis", "Myosteatosis") %>%
                 str_remove(., "area_|volume_") %>% 
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall() %>%
  modify_header(label ~ "**DAFS**",
                all_stat_cols() ~ "**{level}**, N = {n}")

tbl_mid <- data %>%
  select(l3mid_skm_area_cm2, l3mid_sat_area_cm2, l3mid_vat_area_cm2, l3mid_imat_area_cm2,
         l3mid_skm_volume_cm3, l3mid_sat_volume_cm3, l3mid_vat_volume_cm3, l3mid_imat_volume_cm3,
         l3mid_skm_hu_mean, l3mid_myosteatosis,
         l3mid_v_s_ratio_cm2, l3mid_v_s_ratio_cm3,
         l3mid_tat_cm2, l3mid_tat_cm3,
         site) %>%
  `colnames<-`(str_remove(colnames(.), "l3mid_") %>%
                 str_replace(., "v_s", "V/S") %>%
                 str_replace(., "tat", "TAT") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "skm", "Skeleton muscle") %>%
                 str_replace(., "hu_mean", "HU") %>%
                 str_replace(., "myosteatosis", "Myosteatosis") %>%
                 str_remove(., "area_|volume_") %>% 
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall()

tbl_l3startend <- data %>%
  select(l3start_l3end_skm_area_cm2, l3start_l3end_sat_area_cm2, l3start_l3end_vat_area_cm2, l3start_l3end_imat_area_cm2,
         l3start_l3end_skm_volume_cm3, l3start_l3end_sat_volume_cm3, l3start_l3end_vat_volume_cm3, l3start_l3end_imat_volume_cm3,
         l3start_l3end_skm_hu_mean, l3start_l3end_myosteatosis,
         l3start_l3end_v_s_ratio_cm2, l3start_l3end_v_s_ratio_cm3,
         l3start_l3end_tat_cm2, l3start_l3end_tat_cm3,
         site) %>%
  `colnames<-`(str_remove(colnames(.), "l3start_l3end_") %>%
                 str_replace(., "v_s", "V/S") %>%
                 str_replace(., "tat", "TAT") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "skm", "Skeleton muscle") %>%
                 str_replace(., "hu_mean", "HU") %>%
                 str_replace(., "myosteatosis", "Myosteatosis") %>%
                 str_remove(., "area_|volume_") %>% 
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall()

tbl_raw <- tbl_merge(list(tbl_midavg, tbl_mid, tbl_l3startend),
                 tab_spanner = c("**L3 midavg**", "**L3 mid**", "**L3 l3startend**"))
```

```{r site index}
tbl_midavg <- data %>%
  select(l3midavg_smi, l3midavg_sarcopenia, l3midavg_sat_area_cm2_index, l3midavg_vat_area_cm2_index, l3midavg_imat_area_cm2_index,
         l3midavg_skm_volume_cm3_index, l3midavg_sat_volume_cm3_index, l3midavg_vat_volume_cm3_index, l3midavg_imat_volume_cm3_index,
         site) %>% 
  `colnames<-`(str_remove(colnames(.), "l3midavg_") %>%
                 str_replace(., "smi", "SMI") %>%
                 str_replace(., "sarcopenia", "Sarcopenia") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "skm", "Skeleton muscle") %>%
                 str_remove(., "area_|volume_") %>% 
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall() %>%
  modify_header(label ~ "**DAFS**",
                all_stat_cols() ~ "**{level}**, N = {n}")

tbl_mid <- data %>%
  select(l3mid_smi, l3mid_sarcopenia, l3mid_sat_area_cm2_index, l3mid_vat_area_cm2_index, l3mid_imat_area_cm2_index,
         l3mid_skm_volume_cm3_index, l3mid_sat_volume_cm3_index, l3mid_vat_volume_cm3_index, l3mid_imat_volume_cm3_index,
         site) %>%
  `colnames<-`(str_remove(colnames(.), "l3mid_") %>%
                 str_replace(., "smi", "SMI") %>%
                 str_replace(., "sarcopenia", "Sarcopenia") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "skm", "Skeleton muscle") %>%
                 str_remove(., "area_|volume_") %>% 
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall()

tbl_l3startend <- data %>%
  select(l3start_l3end_smi, l3start_l3end_sarcopenia, l3start_l3end_sat_area_cm2_index, l3start_l3end_vat_area_cm2_index, l3start_l3end_imat_area_cm2_index,
         l3start_l3end_skm_volume_cm3_index, l3start_l3end_sat_volume_cm3_index, l3start_l3end_vat_volume_cm3_index, l3start_l3end_imat_volume_cm3_index,
         site) %>%
  `colnames<-`(str_remove(colnames(.), "l3start_l3end_") %>%
                 str_replace(., "smi", "SMI") %>%
                 str_replace(., "sarcopenia", "Sarcopenia") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "skm", "Skeleton muscle") %>%
                  str_remove(., "area_|volume_") %>% 
                str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall()

tbl_index <- tbl_merge(list(tbl_midavg, tbl_mid, tbl_l3startend),
                 tab_spanner = c("**L3 midavg**", "**L3 mid**", "**L3 l3startend**"))
```

```{r site prop}
tbl_midavg <- data %>%
  select(l3midavg_muscle_proportion_cm2, l3midavg_sat_proportion_cm2, l3midavg_vat_proportion_cm2, l3midavg_imat_proportion_cm2,
         l3midavg_muscle_proportion_cm3, l3midavg_sat_proportion_cm3, l3midavg_vat_proportion_cm3, l3midavg_imat_proportion_cm3,
         site) %>% 
  `colnames<-`(str_remove(colnames(.), "l3midavg_") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "muscle_", "Skeleton muscle_") %>%
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall() %>%
  modify_header(label ~ "**DAFS**",
                all_stat_cols() ~ "**{level}**, N = {n}")

tbl_mid <- data %>%
  select(l3mid_muscle_proportion_cm2, l3mid_sat_proportion_cm2, l3mid_vat_proportion_cm2, l3mid_imat_proportion_cm2,
         l3mid_muscle_proportion_cm3, l3mid_sat_proportion_cm3, l3mid_vat_proportion_cm3, l3mid_imat_proportion_cm3,
         site) %>%
  `colnames<-`(str_remove(colnames(.), "l3mid_") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "muscle_", "Skeleton muscle_") %>%
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall()

tbl_l3startend <- data %>%
  select(l3start_l3end_muscle_proportion_cm2, l3start_l3end_sat_proportion_cm2, l3start_l3end_vat_proportion_cm2, l3start_l3end_imat_proportion_cm2,
         l3start_l3end_muscle_proportion_cm3, l3start_l3end_sat_proportion_cm3, l3start_l3end_vat_proportion_cm3, l3start_l3end_imat_proportion_cm3,
         site) %>%
  `colnames<-`(str_remove(colnames(.), "l3start_l3end_") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "muscle_", "Skeleton muscle_") %>%
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall()

tbl_prop <- tbl_merge(list(tbl_midavg, tbl_mid, tbl_l3startend),
                 tab_spanner = c("**L3 midavg**", "**L3 mid**", "**L3 l3startend**"))
```

```{r site ascites}
tbl_midavg <- data %>%
  select(l3midavg_ascites_full_area_cm2, l3midavg_ascites_exudative_area_cm2, l3midavg_ascites_transudative_area_cm2, 
         l3midavg_ascites_hemoperitoneum_area_cm2, 
         l3midavg_ascites_full_volume_cm3, l3midavg_ascites_exudative_volume_cm3, l3midavg_ascites_transudative_volume_cm3, 
         l3midavg_ascites_hemoperitoneum_volume_cm3,
         site) %>% 
  `colnames<-`(str_remove(colnames(.), "l3midavg_") %>%
                 str_replace(., "ascites", "Ascites") %>%
                 str_remove(., "area_|volume_") %>% 
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall() %>%
  modify_header(label ~ "**DAFS**",
                all_stat_cols() ~ "**{level}**, N = {n}")

tbl_mid <- data %>%
  select(l3mid_ascites_full_area_cm2, l3mid_ascites_exudative_area_cm2, l3mid_ascites_transudative_area_cm2, 
         l3mid_ascites_hemoperitoneum_area_cm2, 
         l3mid_ascites_full_volume_cm3, l3mid_ascites_exudative_volume_cm3, l3mid_ascites_transudative_volume_cm3, 
         l3mid_ascites_hemoperitoneum_volume_cm3,
         site) %>%
  `colnames<-`(str_remove(colnames(.), "l3mid_") %>%
                 str_replace(., "ascites", "Ascites") %>%
                 str_remove(., "area_|volume_") %>% 
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall()

tbl_l3startend <- data %>%
  select(l3start_l3end_ascites_full_area_cm2, l3start_l3end_ascites_exudative_area_cm2, l3start_l3end_ascites_transudative_area_cm2, 
         l3start_l3end_ascites_hemoperitoneum_area_cm2, 
         l3start_l3end_ascites_full_volume_cm3, l3start_l3end_ascites_exudative_volume_cm3, l3start_l3end_ascites_transudative_volume_cm3, 
         l3start_l3end_ascites_hemoperitoneum_volume_cm3,
         site) %>%
  `colnames<-`(str_remove(colnames(.), "l3start_l3end_") %>%
                 str_replace(., "ascites", "Ascites") %>%
                 str_remove(., "area_|volume_") %>% 
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall()

tbl_ascites <- tbl_merge(list(tbl_midavg, tbl_mid, tbl_l3startend),
                 tab_spanner = c("**L3 midavg**", "**L3 mid**", "**L3 l3startend**"))
```

```{r site gt}
gt_tbl <- tbl_stack(list(tbl_raw, tbl_index, tbl_prop, tbl_ascites), 
                    group_header = c("Raw features", "Indexed features", "Tissue proportion", "Ascites")) %>%
  as_gt(#rownames_to_stub = TRUE
  ) %>%
  gt::tab_options(row_group.border.top.color = "black",
                  row_group.border.top.width = 3,
                  row_group.border.bottom.color = "darkgrey",
                  row_group.font.size = 15,
                  row_group.font.weight = "bold",
                  row_group.text_transform = "uppercase",
                  row_group.background.color = "grey")
# gt_tbl


# gt_tbl %>% #as_gt(rownames_to_stub = TRUE) %>% 
#   data_color(
#     # columns = everything(),
#     rows = c(5:6),
#     direction = "row",
#     # rows = ends_with("SMI"),
#     palette = "lightblue", na_color = "lightblue", 
#     apply_to = "fill"
#   )



gt_tbl %>%
  data_color(
    direction = "row",
    rows = 1:8,
    # rows = ends_with("SMI"),
    palette = "lightblue", na_color = "lightblue"
  ) %>%
  data_color(
    direction = "row",
    rows = 17:24,
    # rows = ends_with("SMI"),
    palette = "lightblue", na_color = "lightblue"
  ) %>%
  data_color(
    direction = "row",
    rows = 27:28,
    # rows = ends_with("SMI"),
    palette = "lightblue", na_color = "lightblue"
  ) %>%
  data_color(
    direction = "row",
    rows = 31:42,
    # rows = ends_with("SMI"),
    palette = "lightblue", na_color = "lightblue"
  ) %>%
  data_color(
    direction = "row",
    rows = 51:58,
    # rows = ends_with("SMI"),
    palette = "lightblue", na_color = "lightblue"
  ) %>%
  data_color(
    direction = "row",
    rows = 67:74,
    # rows = ends_with("SMI"),
    palette = "lightblue", na_color = "lightblue"
  )
```

### b. Categorical
```{r cat table by site}
tbl_midavg <- data %>%
  select(l3midavg_skm_area_cm2_tertcat, l3midavg_sat_area_cm2_tertcat, l3midavg_vat_area_cm2_tertcat, l3midavg_imat_area_cm2_tertcat, 
         l3midavg_skm_volume_cm3_tertcat, l3midavg_sat_volume_cm3_tertcat, l3midavg_vat_volume_cm3_tertcat, l3midavg_imat_volume_cm3_tertcat,
         l3midavg_skm_hu_mean_tertcat,
         l3midavg_v_s_ratio_cm2_tertcat, l3midavg_v_s_ratio_cm3_tertcat,
         l3midavg_tat_cm2_tertcat, l3midavg_tat_cm3_tertcat,
         site) %>%
  `colnames<-`(str_remove(colnames(.), "l3midavg_") %>%
                 str_replace(., "tertcat", "(cat)") %>%
                 str_replace(., "v_s", "V/S") %>%
                 str_replace(., "tat", "TAT") %>%
                 str_replace(., "smi", "SMI") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "skm", "Skeleton muscle") %>%
                 str_replace(., "volume_cm3", "cm3") %>%
                 str_replace(., "area_cm2", "cm2") %>%
                 str_replace(., "hu_mean", "HU") %>%
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall() %>%
  modify_header(label ~ "**DAFS**",
                all_stat_cols() ~ "**{level}**, N = {n}")

tbl_mid <- data %>%
  select(l3mid_skm_area_cm2_tertcat, l3mid_sat_area_cm2_tertcat, l3mid_vat_area_cm2_tertcat, l3mid_imat_area_cm2_tertcat, 
         l3mid_skm_volume_cm3_tertcat, l3mid_sat_volume_cm3_tertcat, l3mid_vat_volume_cm3_tertcat, l3mid_imat_volume_cm3_tertcat,
         l3mid_skm_hu_mean_tertcat,
         l3mid_v_s_ratio_cm2_tertcat, l3mid_v_s_ratio_cm3_tertcat,
         l3mid_tat_cm2_tertcat, l3mid_tat_cm3_tertcat,
         site) %>%
  `colnames<-`(str_remove(colnames(.), "l3mid_") %>%
                 str_replace(., "tertcat", "(cat)") %>%
                 str_replace(., "v_s", "V/S") %>%
                 str_replace(., "tat", "TAT") %>%
                 str_replace(., "smi", "SMI") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "skm", "Skeleton muscle") %>%
                 str_replace(., "volume_cm3", "cm3") %>%
                 str_replace(., "area_cm2", "cm2") %>%
                 str_replace(., "hu_mean", "HU") %>%
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall()

tbl_l3startend <- data %>%
  select(l3start_l3end_skm_area_cm2_tertcat, l3start_l3end_sat_area_cm2_tertcat, l3start_l3end_vat_area_cm2_tertcat, l3start_l3end_imat_area_cm2_tertcat, 
         l3start_l3end_skm_volume_cm3_tertcat, l3start_l3end_sat_volume_cm3_tertcat, l3start_l3end_vat_volume_cm3_tertcat, l3start_l3end_imat_volume_cm3_tertcat,
         l3start_l3end_skm_hu_mean_tertcat,
         l3start_l3end_v_s_ratio_cm2_tertcat, l3start_l3end_v_s_ratio_cm3_tertcat,
         l3start_l3end_tat_cm2_tertcat, l3start_l3end_tat_cm3_tertcat,
         site) %>%
  `colnames<-`(str_remove(colnames(.), "l3start_l3end_") %>%
                 str_replace(., "tertcat", "(cat)") %>%
                 str_replace(., "v_s", "V/S") %>%
                 str_replace(., "tat", "TAT") %>%
                 str_replace(., "smi", "SMI") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "skm", "Skeleton muscle") %>%
                 str_replace(., "volume_cm3", "cm3") %>%
                 str_replace(., "area_cm2", "cm2") %>%
                 str_replace(., "hu_mean", "HU") %>%
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall()

tbl_raw <- tbl_merge(list(tbl_midavg, tbl_mid, tbl_l3startend),
                 tab_spanner = c("**L3 midavg**", "**L3 mid**", "**L3 l3startend**"))
```

```{r cat site index}
tbl_midavg <- data %>%
  select(l3midavg_smi_tertcat, l3midavg_sat_area_cm2_index_tertcat, l3midavg_vat_area_cm2_index_tertcat, l3midavg_imat_area_cm2_index_tertcat,
         l3midavg_skm_volume_cm3_index_tertcat, l3midavg_sat_volume_cm3_index_tertcat, l3midavg_vat_volume_cm3_index_tertcat, l3midavg_imat_volume_cm3_index_tertcat,
         site) %>% 
  `colnames<-`(str_remove(colnames(.), "l3midavg_") %>%
                 str_replace(., "tertcat", "(cat)") %>%
                 str_replace(., "smi", "SMI") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "skm", "Skeleton muscle") %>%
                 str_remove(., "area_|volume_") %>% 
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall() %>%
  modify_header(label ~ "**DAFS**",
                all_stat_cols() ~ "**{level}**, N = {n}")

tbl_mid <- data %>%
  select(l3mid_smi_tertcat, l3mid_sat_area_cm2_index_tertcat, l3mid_vat_area_cm2_index_tertcat, l3mid_imat_area_cm2_index_tertcat,
         l3mid_skm_volume_cm3_index_tertcat, l3mid_sat_volume_cm3_index_tertcat, l3mid_vat_volume_cm3_index_tertcat, l3mid_imat_volume_cm3_index_tertcat,
         site) %>%
  `colnames<-`(str_remove(colnames(.), "l3mid_") %>%
                 str_replace(., "tertcat", "(cat)") %>%
                 str_replace(., "smi", "SMI") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "skm", "Skeleton muscle") %>%
                 str_remove(., "area_|volume_") %>% 
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall()

tbl_l3startend <- data %>%
  select(l3start_l3end_smi_tertcat, l3start_l3end_sat_area_cm2_index_tertcat, l3start_l3end_vat_area_cm2_index_tertcat, l3start_l3end_imat_area_cm2_index_tertcat,
         l3start_l3end_skm_volume_cm3_index_tertcat, l3start_l3end_sat_volume_cm3_index_tertcat, l3start_l3end_vat_volume_cm3_index_tertcat, l3start_l3end_imat_volume_cm3_index_tertcat,
         site) %>%
  `colnames<-`(str_remove(colnames(.), "l3start_l3end_") %>%
                 str_replace(., "tertcat", "(cat)") %>%
                 str_replace(., "smi", "SMI") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "skm", "Skeleton muscle") %>%
                  str_remove(., "area_|volume_") %>% 
                str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall()

tbl_index <- tbl_merge(list(tbl_midavg, tbl_mid, tbl_l3startend),
                 tab_spanner = c("**L3 midavg**", "**L3 mid**", "**L3 l3startend**"))
```

```{r cat site prop}
tbl_midavg <- data %>%
  select(l3midavg_muscle_proportion_cm2_tertcat, l3midavg_sat_proportion_cm2_tertcat, l3midavg_vat_proportion_cm2_tertcat, l3midavg_imat_proportion_cm2_tertcat,
         l3midavg_muscle_proportion_cm3_tertcat, l3midavg_sat_proportion_cm3_tertcat, l3midavg_vat_proportion_cm3_tertcat, l3midavg_imat_proportion_cm3_tertcat,
         site) %>% 
  `colnames<-`(str_remove(colnames(.), "l3midavg_") %>%
                 str_replace(., "tertcat", "(cat)") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "muscle_", "Skeleton muscle_") %>%
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall() %>%
  modify_header(label ~ "**DAFS**",
                all_stat_cols() ~ "**{level}**, N = {n}")

tbl_mid <- data %>%
  select(l3mid_muscle_proportion_cm2_tertcat, l3mid_sat_proportion_cm2_tertcat, l3mid_vat_proportion_cm2_tertcat, l3mid_imat_proportion_cm2_tertcat,
         l3mid_muscle_proportion_cm3_tertcat, l3mid_sat_proportion_cm3_tertcat, l3mid_vat_proportion_cm3_tertcat, l3mid_imat_proportion_cm3_tertcat,
         site) %>%
  `colnames<-`(str_remove(colnames(.), "l3mid_") %>%
                 str_replace(., "tertcat", "(cat)") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "muscle_", "Skeleton muscle_") %>%
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall()

tbl_l3startend <- data %>%
  select(l3start_l3end_muscle_proportion_cm2_tertcat, l3start_l3end_sat_proportion_cm2_tertcat, l3start_l3end_vat_proportion_cm2_tertcat, l3start_l3end_imat_proportion_cm2_tertcat,
         l3start_l3end_muscle_proportion_cm3_tertcat, l3start_l3end_sat_proportion_cm3_tertcat, l3start_l3end_vat_proportion_cm3_tertcat, l3start_l3end_imat_proportion_cm3_tertcat,
         site) %>%
  `colnames<-`(str_remove(colnames(.), "l3start_l3end_") %>%
                 str_replace(., "tertcat", "(cat)") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "muscle_", "Skeleton muscle_") %>%
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall()

tbl_prop <- tbl_merge(list(tbl_midavg, tbl_mid, tbl_l3startend),
                 tab_spanner = c("**L3 midavg**", "**L3 mid**", "**L3 l3startend**"))
```

```{r cat site gt}
gt_tbl <- tbl_stack(list(tbl_raw, tbl_index, tbl_prop), 
                    group_header = c("Raw features", "Indexed features", "Tissue proportion")) %>%
  as_gt(#rownames_to_stub = TRUE
  ) %>%
  gt::tab_options(row_group.border.top.color = "black",
                  row_group.border.top.width = 3,
                  row_group.border.bottom.color = "darkgrey",
                  row_group.font.size = 15,
                  row_group.font.weight = "bold",
                  row_group.text_transform = "uppercase",
                  row_group.background.color = "grey")
# gt_tbl
gt_tbl %>%
  data_color(
    columns = everything(),
    rows = 1:20,
    # rows = ends_with("SMI"),
    palette = "lightblue", na_color = "lightblue"
  ) %>%
  data_color(
    columns = everything(),
    rows = 41:50,
    # rows = ends_with("SMI"),
    palette = "lightblue", na_color = "lightblue"
  ) %>%
  data_color(
    columns = everything(),
    rows = 56:60,
    # rows = ends_with("SMI"),
    palette = "lightblue", na_color = "lightblue"
  ) %>%
  data_color(
    columns = everything(),
    rows = 66:85,
    # rows = ends_with("SMI"),
    palette = "lightblue", na_color = "lightblue"
  ) %>%
  data_color(
    columns = everything(),
    rows = 106:125,
    # rows = ends_with("SMI"),
    palette = "lightblue", na_color = "lightblue"
  )
```

There is some differences between Moffitt and Roswell body composition data for:
- IMAT cm3.  
- VAT cm3.  
- SKM cm3 and muscle HU.  


<br>




# III. Body composition features vs BMI - Focus on l3midavg
## 1. Categorical BMI
1- When comparing cm2 to cm3, all features distribution are similar BUT indexed muscle mass.  
2- IMAT, SAT, VAT, TAT in cm2 and cm3 indexed correlate with BMI.   

3- Proportion show some differences especially for IMAT and VAT for which the distributions are similar for the 2 highest BMI groups.   
4- V/S ratios are also similar for the 2 top BMI groups (BMI categories 25-30 and ≥30).   
5- Muscle HU show inverse correlation with BMI.    
6- Conversely SMI follows BMI, but indexed muscle cm3 has a similar median for the 2 highest BMI groups.   

```{r boxplot BMI, fig.height=10, fig.width=10}
midavg_data <- data %>%
  select(starts_with("l3midavg_") & contains("_ratio"),
         starts_with("l3midavg_") & contains("_tat"),
         starts_with("l3midavg_") & contains("_proportion"),
         starts_with("l3midavg_") & ends_with("_smi"),
         starts_with("l3midavg_") & ends_with("_index"),
         starts_with("l3midavg_") & contains("skm_hu"),
         # starts_with("l3midavg_") & contains("ascites"),
         bmi_cat, deidentified_patient_id,
         -c(starts_with("l3midavg_") & ends_with("_tertcat")),
         -c(starts_with("l3midavg_") & ends_with("_sdhr"))
         )

midavg_data %>%
  filter(!is.na(bmi_cat)) %>%
  `colnames<-`(str_remove(colnames(.), "l3midavg_")) %>%
  pivot_longer(cols = -c(deidentified_patient_id, bmi_cat),
               names_to = "Feature", values_to = "value") %>%
  mutate(Feature = factor(Feature,
                          levels = c("vat_area_cm2_index", "sat_area_cm2_index", "imat_area_cm2_index",
                                     "vat_volume_cm3_index", "sat_volume_cm3_index", "imat_volume_cm3_index",
                                     "vat_proportion_cm2", "sat_proportion_cm2", "imat_proportion_cm2",
                                     "vat_proportion_cm3", "sat_proportion_cm3", "imat_proportion_cm3",
                                     "v_s_ratio_cm2", "tat_cm2", "smi",
                                     "v_s_ratio_cm3", "tat_cm3", "skm_volume_cm3_index", 
                                     "skm_hu_mean", "muscle_proportion_cm2", "muscle_proportion_cm3"
                                     ))) %>%
  mutate(bmi_cat = factor(bmi_cat, levels = c("≥30 kg/m²", "25-30 kg/m²", "<25 kg/m²"))) %>%
  ggplot(aes(x = bmi_cat, y = value, color = bmi_cat))+
  geom_boxplot()+
  # geom_jitter(color = "grey")+
  scale_color_viridis_d(option = "G", end = c(0.6),
                        limits = c("<25 kg/m²",
                                   "25-30 kg/m²",
                                   "≥30 kg/m²"))+
  facet_wrap(. ~ Feature, ncol = 3, scales = "free")+
  coord_flip()+
  theme(axis.text.y = element_blank(),
        axis.title = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "bottom")
```
<br>

## 2. Continuous BMI
Same observation as in the previous plot (orange rectangle).
Another observation here is that continuous ascites features don't not seem to correlate with continuous BMI (pink rectangle) or VAT (purple rectangle).
```{r, fig.height=12, fig.width=12}
midavg_data <- data %>%
  select(starts_with("l3midavg_") & contains("_ratio"),
         starts_with("l3midavg_") & contains("_tat"),
         starts_with("l3midavg_") & contains("_proportion"),
         starts_with("l3midavg_") & ends_with("_smi"),
         starts_with("l3midavg_") & ends_with("_index"),
         starts_with("l3midavg_") & contains("skm_hu"),
         starts_with("l3midavg_") & contains("ascites"),
         bmi,
         -c(starts_with("l3midavg_") & ends_with("_tertcat")),
         -c(starts_with("l3midavg_") & ends_with("_sdhr"))
         ) %>%
  `colnames<-`(str_remove(colnames(.), "l3midavg_") %>%
                 str_replace(., "bmi", "BMI") %>%
                 str_remove(., "volume_") %>%
                 str_remove(., "area_") %>%
                 str_replace(., "v_s", "V/S") %>%
                 str_replace(., "tat", "TAT") %>%
                 str_replace(., "smi", "SMI") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "skm", "Skeleton muscle") %>%
                 str_replace(., "hu_mean", "HU") %>%
                 str_replace(., "ascites", "Ascites") %>%
                 str_replace_all(., "_", " "))

# a <- features[, 5:310] %>% select(contains("statistical")) %>% select(where(~ any(. != 0)))
midavg_mat <- cor(midavg_data, use = "pairwise.complete.obs")
ggcorrplot(midavg_mat, #hc.order = TRUE,
           method = "circle",
           type = "lower",
           lab = TRUE,
           title = "Correlation between features AND BMI",
           show.legend = TRUE, legend.title = "Correlation", show.diag = TRUE,
           lab_col = "darkblue", lab_size = 3,
           sig.level = 0.05, insig = c("pch", "blank"), pch = 4, pch.col = "black", pch.cex = 10,
           tl.cex = 10, tl.col = "green", tl.srt = 40,
           digits = 2
)+
  # geom_abline(intercept = 0, slope = 1)+
  geom_rect(aes(xmin = 29.6, xmax = 30.5, ymin = 0.5, ymax = 21.5), fill = "transparent", color = "orange")+
  geom_rect(aes(xmin = 21.5, xmax = 29.4, ymin = 0.5, ymax = 21.5), fill = "transparent", color = "orchid")+
  geom_rect(aes(xmin = 21.5, xmax = 29.4, ymin = 19.5, ymax = 20.5), fill = "transparent", color = "purple")+
  theme(legend.position = "bottom")
```


# IV. Ascites
## First let's look at HR using the continuous variables
```{r}
tbl_uvregression(
  data,
  method = coxph,
  y = Surv(time = os_time_from_dx_months, event = os_event),
  exponentiate = TRUE,
  include = c("l3midavg_ascites_exudative_area_cm2", "l3midavg_ascites_exudative_volume_cm3",
              "l3midavg_ascites_transudative_area_cm2", "l3midavg_ascites_transudative_volume_cm3",
              "l3midavg_ascites_hemoperitoneum_area_cm2", "l3midavg_ascites_hemoperitoneum_volume_cm3",
              "l3midavg_ascites_full_area_cm2", "l3midavg_ascites_full_volume_cm3"
              ),
  # pvalue_fun = label_style_pvalue(digits = 2)
  ) %>%
  bold_p(t = .05) %>%
  add_nevent(location = "level") %>% add_n(location = "level") %>%
  bold_labels() %>% italicize_levels()

a <- data %>% select(ct_patient_id,
                     l3midavg_ascites_exudative_area_cm2, l3midavg_ascites_transudative_area_cm2, 
                     l3midavg_ascites_hemoperitoneum_area_cm2, l3midavg_ascites_full_area_cm2) %>% 
  mutate(addsum = rowSums(select(., l3midavg_ascites_exudative_area_cm2 : l3midavg_ascites_hemoperitoneum_area_cm2)))
```

## 1. Compare DAFS L3 acsites values vs recorded clinical data - Moffit set
We have data for these 4 ascites types : ASCITES, ASCITES[-10,10], ASCITES[16,2048], ASCITES[46,2048].    
The first one “ASCITES” is an overall reading of all the 3 other ascites values but without the threshold apply. So they cannot be added up.   

For the first analysis (Scliceomatic), Dan recorded manually presence/absence of ascites and their severity.
The first plot compare this abstracted data to the "l3midavg_ascites_xxx" values from DAFS. L3mid and L3start-end are shown in the following plots.

Please find more explanation under the plots.
```{r ridges ascites, fig.height=12, fig.width=12}
sev_ascites <- data %>%
  filter(!is.na(ascites_severity)) %>%
  select(ascites_severity, #ascites,
         starts_with("l3midavg_") & contains("ascites")) %>%
  pivot_longer(-ascites_severity, names_to = "Features", values_to = "value") %>%
  mutate(Features = str_remove_all(Features, "volume_|area_"),
         Features = str_replace_all(Features, "l3midavg_ascites", "Ascites"),
         Features = str_replace_all(Features, "_", " ")) %>%
  mutate(dat = "Severity")

data %>%
  filter(!is.na(ascites)) %>%
  select(ascites_severity = ascites, #ascites,
         starts_with("l3midavg_") & contains("ascites")) %>%
  pivot_longer(-ascites_severity, names_to = "Features", values_to = "value") %>%
  mutate(Features = str_remove_all(Features, "volume_|area_"),
         Features = str_replace_all(Features, "l3midavg_ascites", "Ascites"),
         Features = str_replace_all(Features, "_", " ")) %>%
  mutate(dat = "Presence/Absence") %>%
  bind_rows(., sev_ascites) %>%
  mutate(ascites_severity = factor(ascites_severity, levels = c("mild", "moderate", "severe",
                                                                "absence", "presence"))) %>%
  ggplot(aes(y = Features, x = value,
             fill = ascites_severity, color = ascites_severity)) +
  geom_density_ridges(alpha = 0.2) +
  labs(title = "l3midavg_", x = "DAFS values")+
  scale_y_discrete(expand = c(0, 0.1))+
  scale_x_continuous(limits = c(-20, 150))+
  theme_ridges()+
  theme(panel.spacing = unit(0.1, "lines"),
        axis.title.y = element_blank(),
        legend.position = "bottom")+
  facet_wrap(. ~ dat)

sev_ascites <- data %>%
  filter(!is.na(ascites_severity)) %>%
  select(ascites_severity, #ascites,
         starts_with("l3mid_") & contains("ascites")) %>%
  pivot_longer(-ascites_severity, names_to = "Features", values_to = "value") %>%
  mutate(Features = str_remove_all(Features, "volume_|area_"),
         Features = str_replace_all(Features, "l3mid_ascites", "Ascites"),
         Features = str_replace_all(Features, "_", " ")) %>%
  mutate(dat = "Severity")

data %>%
  filter(!is.na(ascites)) %>%
  select(ascites_severity = ascites, #ascites,
         starts_with("l3mid_") & contains("ascites")) %>%
  pivot_longer(-ascites_severity, names_to = "Features", values_to = "value") %>%
  mutate(Features = str_remove_all(Features, "volume_|area_"),
         Features = str_replace_all(Features, "l3mid_ascites", "Ascites"),
         Features = str_replace_all(Features, "_", " ")) %>%
  mutate(dat = "Presence/Absence") %>%
  bind_rows(., sev_ascites) %>%
  mutate(ascites_severity = factor(ascites_severity, levels = c("mild", "moderate", "severe",
                                                                "absence", "presence"))) %>%
  ggplot(aes(y = Features, x = value,
             fill = ascites_severity, color = ascites_severity)) +
  geom_density_ridges(alpha = 0.2) +
  labs(title = "l3mid", x = "DAFS values")+
  scale_y_discrete(expand = c(0, 0.1))+
  scale_x_continuous(limits = c(-20, 150))+
  theme_ridges()+
  theme(panel.spacing = unit(0.1, "lines"),
        axis.title.y = element_blank(),
        legend.position = "bottom")+
  facet_wrap(. ~ dat)

sev_ascites <- data %>%
  filter(!is.na(ascites_severity)) %>%
  select(ascites_severity, #ascites,
         starts_with("l3start_l3end_") & contains("ascites")) %>%
  pivot_longer(-ascites_severity, names_to = "Features", values_to = "value") %>%
  mutate(Features = str_remove_all(Features, "volume_|area_"),
         Features = str_replace_all(Features, "l3start_l3end_ascites", "Ascites"),
         Features = str_replace_all(Features, "_", " ")) %>%
  mutate(dat = "Severity")

data %>%
  filter(!is.na(ascites)) %>%
  select(ascites_severity = ascites, #ascites,
         starts_with("l3start_l3end_") & contains("ascites")) %>%
  pivot_longer(-ascites_severity, names_to = "Features", values_to = "value") %>%
  mutate(Features = str_remove_all(Features, "volume_|area_"),
         Features = str_replace_all(Features, "l3start_l3end_ascites", "Ascites"),
         Features = str_replace_all(Features, "_", " ")) %>%
  mutate(dat = "Presence/Absence") %>%
  bind_rows(., sev_ascites) %>%
  mutate(ascites_severity = factor(ascites_severity, levels = c("mild", "moderate", "severe",
                                                                "absence", "presence"))) %>%
  ggplot(aes(y = Features, x = value,
             fill = ascites_severity, color = ascites_severity)) +
  geom_density_ridges(alpha = 0.2) +
  labs(title = "l3start_l3end_", x = "DAFS values")+
  scale_y_discrete(expand = c(0, 0.1))+
  scale_x_continuous(limits = c(-20, 150))+
  theme_ridges()+
  theme(panel.spacing = unit(0.1, "lines"),
        axis.title.y = element_blank(),
        legend.position = "bottom")+
  facet_wrap(. ~ dat)
```
Full plots with severe ascites variables (useful to see the tail of the distributions)
```{r full ridges ascites}
data %>%
  filter(!is.na(ascites_severity)) %>%
  select(ascites_severity,
         starts_with("l3midavg_") & contains("ascites")) %>%
  pivot_longer(-ascites_severity, names_to = "Features", values_to = "value") %>%
  mutate(Features = str_remove_all(Features, "volume_|area_"),
         Features = str_replace_all(Features, "l3midavg_ascites", "Ascites"),
         Features = str_replace_all(Features, "_", " ")) %>%
  mutate(ascites_severity = factor(ascites_severity, levels = c("mild", "moderate", "severe",
                                                                "absence", "presence"))) %>%
  ggplot(aes(y = Features, x = value,
             fill = ascites_severity, color = ascites_severity)) +
  geom_density_ridges(alpha = 0.2) +
  labs(title = "l3midavg_", x = "DAFS values")+
  scale_y_discrete(expand = c(0, 0.2))+
  theme_ridges()+
  theme(panel.spacing = unit(0.1, "lines"),
        axis.title.y = element_blank(),
        legend.position = "bottom")

data %>%
  filter(!is.na(ascites_severity)) %>%
  select(ascites_severity,
         starts_with("l3mid_") & contains("ascites")) %>%
  pivot_longer(-ascites_severity, names_to = "Features", values_to = "value") %>%
  mutate(Features = str_remove_all(Features, "volume_|area_"),
         Features = str_replace_all(Features, "l3mid_ascites", "Ascites"),
         Features = str_replace_all(Features, "_", " ")) %>%
  mutate(ascites_severity = factor(ascites_severity, levels = c("mild", "moderate", "severe",
                                                                "absence", "presence"))) %>%
  ggplot(aes(y = Features, x = value,
             fill = ascites_severity, color = ascites_severity)) +
  geom_density_ridges(alpha = 0.2) +
  labs(title = "l3mid", x = "DAFS values")+
  scale_y_discrete(expand = c(0, 0.2))+
  theme_ridges()+
  theme(panel.spacing = unit(0.1, "lines"),
        axis.title.y = element_blank(),
        legend.position = "bottom")

data %>%
  filter(!is.na(ascites_severity)) %>%
  select(ascites_severity,
         starts_with("l3start_l3end_") & contains("ascites")) %>%
  pivot_longer(-ascites_severity, names_to = "Features", values_to = "value") %>%
  mutate(Features = str_remove_all(Features, "volume_|area_"),
         Features = str_replace_all(Features, "l3start_l3end_ascites", "Ascites"),
         Features = str_replace_all(Features, "_", " ")) %>%
  mutate(ascites_severity = factor(ascites_severity, levels = c("mild", "moderate", "severe",
                                                                "absence", "presence"))) %>%
  ggplot(aes(y = Features, x = value,
             fill = ascites_severity, color = ascites_severity)) +
  geom_density_ridges(alpha = 0.2) +
  labs(title = "l3start_l3end_", x = "DAFS values")+
  scale_y_discrete(expand = c(0, 0.2))+
  theme_ridges()+
  theme(panel.spacing = unit(0.1, "lines"),
        axis.title.y = element_blank(),
        legend.position = "bottom")
```

From Brett,
"1. Ascites Subtypes by HU Range
 2. In addition to the standard ASCITES output from DAFS, we requested separate ascites measures using the following HU ranges to distinguish different ascites types:
  Transudative: –10 to +10 HU
  Exudative: >15 HU
  Hemoperitoneum: >45 HU"
"For determining if they have ascites at all...I would look at the standard Ascites (no range limit) volume and area measures and just do some histograms to see if there is a clear cutoff for those with/without ascites".

<br>

I had the same thought and to me, the best ascites feature to use for creating an ascites category is "ascites_exudative_area_cm2".
In more details:
- It seems that the distributions using presence/absence of acsites are more overlaping than if we look at the severity. It might be due to the fact that some "presence" ascites have NAs for severity and might have been miscategorized...?
- I am more focusing the the severity curves.
- Most l3startend distributions overlap absence/severity. Dan said the best way to look for ascites would be "measure volume of ascites in cm3 between two axial levels such as T12 to L5 or T12 to sacrum depending on availability within the cohort. This involves summing up all the cm3 ascites measurements for each included vertebral body level.". L3startend doesn't fit the idea so I would probably not use this.
- l3mid and l3midavg ascites distributions are more promising to me. They are pretty similar between each other but l3midavg would fit more the idea mentioned above so I think i would go with this.
- For these 2 (l3mid and l3midavg), transudative or hemoperitoneum distribution don't vary much between absence/severity. Then **exudative area** seems to have a better separation between absence/severity.


__More info on ascites types__ 
1).   
(this is a paper on the use of US aka ultrasounds use to detect ascites)
"The peritoneal cavity normally contains approximately 50–75 mls of fluid that serves to lubricate the tissues that line the abdominal wall and viscera. The term ascites is reserved to denote an abnormal accumulation of this fluid.

Ascites is traditionally divided into transudate or exudate based on the protein content. Transudates (protein < 25 g/L) are typically due to increased leakage of fluid secondary to raised intravascular pressure. This is usually due to an underlying systemic illness such as cardiac failure or portal hypertension associated with liver cirrhosis. Hypo-proteinaemia results in reduced oncotic pressure and also causes a transudate, for example from a nephrotic syndrome or protein losing enteropathy. **Conversely, an exudate represents protein rich fluid (protein > 25 g/L) formed secondary to haemorrhage, infection, inflammation or neoplasia.**
US can provide a non-invasive, qualitative assessment of the nature of the fluid. Transudates typically have homogenous, anechoic fluid with deep posterior acoustic enhancement. Exudates demonstrate intrinsic complexity and may have features such as low level echoes, particulate debris and septations. US is more sensitive at demonstrating the internal complex features associated with an exudate when compared to CT, which often only shows a bland ‘grey’ hypo-dense fluid attenuation."

So **exudate** seems to be the ascites which happens in case of neoplasia.
Like I said the best separation between the distribution for Presence/Absence of ascites is for exudative_**area_cm2** so I will be using this even though Dan think the best would be to use volume cm3.

2).   
https://radiopaedia.org/articles/ascites?lang=us.   
The CT density of intraperitoneal fluid may give a clue to the underlying etiology:    
transudative ascites density should be approximate to that of water (-10 to +10 HU).   
exudative ascites (density >15 HU).   
hemoperitoneum density is higher still (~45 HU).   
Of course, other intra- or extra-abdominal CT features may give further evidence to the origin of the ascites, e.g. features of heart failure, features of cirrhosis, peritoneal catheter in situ, etc.



## 2. Set an ascites cutpoint
### Using a median/SD cutpoint
The curves for severe ascites seems strange so I excluded these cases.
```{r}
# set.seed(123)
# d1 <- data.frame(binom=rbinom(1000, 20, 0.2), binomial.p='0.2')
# d2 <- data.frame(binom=rbinom(1000, 20, 0.5),binomial.p='0.5')
# write_rds(d1, "d1.rds")
# write_rds(d2, "d2.rds")

sev_ascites <- data %>%
  filter(!is.na(ascites_severity))
absence_ascites <- sev_ascites %>%
  filter(ascites == "absence") %>%
  select(l3midavg_ascites_exudative_area_cm2) %>%
  mutate(dat = "Absence")
# presence_ascites <- sev_ascites %>%
#   filter(ascites == "presence") %>%
#   select(l3midavg_ascites_exudative_area_cm2) %>%
#   mutate(dat = "Presence")
presence_ascites <- sev_ascites %>%
  filter(ascites_severity == "mild" | ascites_severity == "moderate") %>%
  select(l3midavg_ascites_exudative_area_cm2) %>%
  mutate(dat = "Presence")

median_absence <- median(absence_ascites$l3midavg_ascites_exudative_area_cm2)
sd_absence <- sd(absence_ascites$l3midavg_ascites_exudative_area_cm2)
median_presence <- median(presence_ascites$l3midavg_ascites_exudative_area_cm2)
sd_presence <- sd(presence_ascites$l3midavg_ascites_exudative_area_cm2)
median_cutoff_value <- ((median_presence-median_absence) / (sd_absence+sd_presence)) * sd_absence + median_absence

a <- absence_ascites %>%
  bind_rows(., presence_ascites)
ggplot(a, aes(l3midavg_ascites_exudative_area_cm2, fill=dat)) +
  geom_density(alpha=0.5)+
  scale_fill_manual(values = c("red", "blue"))+
  geom_vline(xintercept = median_absence, color = "red")+
  geom_vline(xintercept = median_presence, color = "blue")+
  geom_vline(xintercept = median_cutoff_value, color = "black")

  # geom_segment(aes(x = median_absence, y = 0.25, xend = cutoff_value, yend = 0.25),
  #              arrow = arrow(ends = "both", length = unit(0.1, "inches")),
  #              color = "red"
  #              )+
  # geom_text(aes(x = median_absence+0.4, y = 0.26, label = "n x SD1"),color = "red",
  #           hjust = 0)+
  #
  # geom_segment(aes(x = cutoff_value, y = 0.25, xend = median_presence, yend = 0.25),
  #              arrow = arrow(ends = "both", length = unit(0.1, "inches")),
  #              color = "blue"
  # )+
  # geom_text(aes(x = cutoff_value+0.6, y = 0.26, label = "n x SD2"),color = "blue",
  #           hjust = 0)+
  #
  # scale_x_continuous(#limits = c(-0.00001,0.0002),# labels = function(x) format(x, scientific = TRUE)
  #                    breaks = c(median_absence, cutoff_value, median_presence),
  #                    labels = c("Mean 1", "cutoff", "Mean 2")
  # )+
  # theme(legend.position = "none",
  #       axis.text.x = element_text(angle = 45,
  #                                  vjust = 1,
  #                                  hjust=1),
  #       axis.title.x = element_blank(),
  #       axis.title.y = element_blank(),
  #       axis.text.y = element_blank(),
  #       axis.ticks.y = element_blank())
```
Using this method the cutoff value is `r median_cutoff_value` (black line). This cutoff seems too high.
Red and blue line represent the median of each l3midavg_ascites_exudative_area_cm2 distributions

### Using cutpointr
```{r}
a <- a %>%
  mutate(dat = as.factor(dat))

library(cutpointr)
cp <- cutpointr(data = a, x = l3midavg_ascites_exudative_area_cm2, class = dat, method = maximize_metric, metric = youden)
print(cp)
plot(cp)
optimal_cutpoint <- cp$optimal_cutpoint
```
Using the cutpointr method the cutoff value is `r optimal_cutpoint`.

### Ascites vs other body composition features
```{r}
data <- data %>%
  mutate(ascites_median_cat = case_when(
    l3midavg_ascites_exudative_area_cm2 <= median_cutoff_value        ~ "Absence",
    l3midavg_ascites_exudative_area_cm2 > median_cutoff_value         ~ "Presence"
  )) %>%
  mutate(ascites_cutpoint_cat = case_when(
    l3midavg_ascites_exudative_area_cm2 <= optimal_cutpoint           ~ "Absence",
    l3midavg_ascites_exudative_area_cm2 > optimal_cutpoint            ~ "Presence"
  )) %>%
  mutate_at(c("ascites_median_cat",
              "ascites_cutpoint_cat"), ~ factor(., levels = c("Absence", "Presence")))

data %>%
  select(starts_with("l3midavg_") & contains("_ratio"),
         starts_with("l3midavg_") & contains("_tat"),
         starts_with("l3midavg_") & contains("_proportion"),
         starts_with("l3midavg_") & ends_with("_smi"),
         starts_with("l3midavg_") & ends_with("_index"),
         starts_with("l3midavg_") & contains("skm_hu"),
         - contains("tertcat"),
         ascites_median_cat) %>%
  `colnames<-`(str_remove(colnames(.), "l3midavg_") %>%
                 str_replace(., "tertcat", "(cat)") %>%
                 str_replace(., "v_s", "V/S") %>%
                 str_replace(., "tat", "TAT") %>%
                 str_replace(., "smi", "SMI") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "skm", "Skeleton muscle") %>%
                 str_replace(., "hu_mean", "HU") %>%
                 str_replace(., "ascites", "Ascites") %>%
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = `Ascites median cat`) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall() %>%
  modify_header(label ~ "**DAFS**",
                all_stat_cols() ~ "**{level}**, N = {n}") %>%
  modify_spanning_header(all_stat_cols() ~ "**Coded using ascites median cutoff**")


data %>%
  select(starts_with("l3midavg_") & contains("_ratio"),
         starts_with("l3midavg_") & contains("_tat"),
         starts_with("l3midavg_") & contains("_proportion"),
         starts_with("l3midavg_") & ends_with("_smi"),
         starts_with("l3midavg_") & ends_with("_index"),
         starts_with("l3midavg_") & contains("skm_hu"),
         - contains("tertcat"),
         ascites_cutpoint_cat) %>%
  `colnames<-`(str_remove(colnames(.), "l3midavg_") %>%
                 str_replace(., "tertcat", "(cat)") %>%
                 str_replace(., "v_s", "V/S") %>%
                 str_replace(., "tat", "TAT") %>%
                 str_replace(., "smi", "SMI") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace(., "skm", "Skeleton muscle") %>%
                 str_replace(., "hu_mean", "HU") %>%
                 str_replace(., "ascites", "Ascites") %>%
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = `Ascites cutpoint cat`) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall() %>%
  modify_header(label ~ "**DAFS**",
                all_stat_cols() ~ "**{level}**, N = {n}") %>%
  modify_spanning_header(all_stat_cols() ~ "**Coded using ascites cutpointr cutoff**")
```

### Ascites by site
```{r}
data %>%
  select(ascites_median_cat,
         ascites_cutpoint_cat,
         site) %>%
  `colnames<-`(str_remove(colnames(.), "l3midavg_") %>%
                 str_replace(., "ascitesgroup", "(cat)") %>%
                 str_replace(., "ascites", "Ascites") %>%
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall() %>%
  modify_header(label ~ "**Ascites**",
                all_stat_cols() ~ "**{level}**, N = {n}")
```

### Ascites and survival
```{r}
tbl_uvregression(
  data,
  method = coxph,
  y = Surv(time = os_time_from_dx_months, event = os_event),
  exponentiate = TRUE,
  include = c("ascites_median_cat", "ascites_cutpoint_cat"
              ),
  # pvalue_fun = label_style_pvalue(digits = 2)
  ) %>%
  bold_p(t = .05) %>%
  add_nevent(location = "level") %>% add_n(location = "level") %>%
  bold_labels() %>% italicize_levels()
```


## 3. Set ascites = 0 to No ascites


### Make a No ascites group
```{r Make a No ascites group}
data <- data %>% 
  mutate(across(c(starts_with("l3midavg_") & 
                    contains("ascites")), ~ case_when(
    . == 0                                           ~ "No ascites",
    !is.na(.)                                        ~ "Yes ascites"
  ), .names = "{.col}_ascitesgroup"))
```

### Ascites by site
```{r}
data %>%
  select(ends_with("_ascitesgroup"),
         raceeth) %>%
  `colnames<-`(str_remove(colnames(.), "l3midavg_") %>%
                 str_replace(., "ascitesgroup", "(cat)") %>%
                 str_replace(., "ascites", "Ascites") %>%
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = raceeth) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall() %>%
  modify_header(label ~ "**Ascites Yes(feature > 0)/No(feature == 0)**",
                all_stat_cols() ~ "**{level}**, N = {n}")
```

### Ascites and survival
```{r}
tbl_uvregression(
  data,
  method = coxph,
  y = Surv(time = os_time_from_dx_months, event = os_event),
  exponentiate = TRUE,
  include = c("l3midavg_ascites_exudative_area_cm2_ascitesgroup", "l3midavg_ascites_exudative_volume_cm3_ascitesgroup",
              "l3midavg_ascites_transudative_area_cm2_ascitesgroup", "l3midavg_ascites_transudative_volume_cm3_ascitesgroup",
              "l3midavg_ascites_hemoperitoneum_area_cm2_ascitesgroup", "l3midavg_ascites_hemoperitoneum_volume_cm3_ascitesgroup",
              "l3midavg_ascites_full_area_cm2_ascitesgroup", "l3midavg_ascites_full_volume_cm3_ascitesgroup"
              ),
  # pvalue_fun = label_style_pvalue(digits = 2)
  ) %>%
  bold_p(t = .05) %>%
  add_nevent(location = "level") %>% add_n(location = "level") %>%
  bold_labels() %>% italicize_levels()
```

```{r KM ascites cat2 group}
ggsurvplot(survfit(Surv(os_time_from_dx_months, event = os_event) ~ 
                     l3midavg_ascites_exudative_area_cm2_ascitesgroup, 
                   data = data), 
           data = data,
           title = "OS Analysis",
           font.main = c(20, "bold", "black"),
           font.x = c(18, "bold", "black"),
           font.y = c(18, "bold", "black"),
           font.legend = c(16, "black"),
           font.tickslab = c(16, "bold", "black"),
           size = 1,

           xlab = "Time (months)",
           legend = "top",
           legend.title = "",
           # legend.labs = c("Low", "High"),
           pval = TRUE,
           conf.int = FALSE,
           # Censor
           censor = TRUE
)
```

```{r Make a No/mild/severe ascites group}
data <- data %>% 
  mutate(across(c(starts_with("l3midavg_") & 
                    contains("ascites"),
                  -contains("ascitesgroup")), ~ na_if(., 0),
                .names = "{.col}_nozero"))
data1 <- data %>% 
  mutate_at("l3midavg_ascites_exudative_area_cm2_ascitesgroup", ~ case_when(
    . == "No ascites"                                ~ "No ascites",
    . == "Yes ascites" &
      l3midavg_ascites_exudative_area_cm2 <= median(l3midavg_ascites_exudative_area_cm2_nozero, na.rm = TRUE)     
    ~ "Mild ascites",
    . == "Yes ascites" &
      l3midavg_ascites_exudative_area_cm2 > median(l3midavg_ascites_exudative_area_cm2_nozero, na.rm = TRUE)      
    ~ "Severe ascites"
  )) %>% 
  mutate_at("l3midavg_ascites_exudative_volume_cm3_ascitesgroup", ~ case_when(
    . == "No ascites"                                ~ "No ascites",
    . == "Yes ascites" &
      l3midavg_ascites_exudative_volume_cm3 <= median(l3midavg_ascites_exudative_volume_cm3_nozero, na.rm = TRUE)    
    ~ "Mild ascites",
    . == "Yes ascites" &
      l3midavg_ascites_exudative_volume_cm3 > median(l3midavg_ascites_exudative_volume_cm3_nozero, na.rm = TRUE)      
    ~ "Severe ascites"
  )) %>% 
  mutate_at("l3midavg_ascites_transudative_area_cm2_ascitesgroup", ~ case_when(
    . == "No ascites"                                ~ "No ascites",
    . == "Yes ascites" &
      l3midavg_ascites_transudative_area_cm2 <= median(l3midavg_ascites_transudative_area_cm2_nozero, na.rm = TRUE)     
    ~ "Mild ascites",
    . == "Yes ascites" &
      l3midavg_ascites_transudative_area_cm2 > median(l3midavg_ascites_transudative_area_cm2_nozero, na.rm = TRUE)      
    ~ "Severe ascites"
  )) %>% 
  mutate_at("l3midavg_ascites_transudative_volume_cm3_ascitesgroup", ~ case_when(
    . == "No ascites"                                ~ "No ascites",
    . == "Yes ascites" &
      l3midavg_ascites_transudative_volume_cm3 <= median(l3midavg_ascites_transudative_volume_cm3_nozero, na.rm = TRUE)     
    ~ "Mild ascites",
    . == "Yes ascites" &
      l3midavg_ascites_transudative_volume_cm3 > median(l3midavg_ascites_transudative_volume_cm3_nozero, na.rm = TRUE)      
    ~ "Severe ascites"
  )) %>% 
  mutate_at("l3midavg_ascites_hemoperitoneum_area_cm2_ascitesgroup", ~ case_when(
    . == "No ascites"                                ~ "No ascites",
    . == "Yes ascites" &
      l3midavg_ascites_hemoperitoneum_area_cm2 <= median(l3midavg_ascites_hemoperitoneum_area_cm2_nozero, na.rm = TRUE)     
    ~ "Mild ascites",
    . == "Yes ascites" &
      l3midavg_ascites_hemoperitoneum_area_cm2 > median(l3midavg_ascites_hemoperitoneum_area_cm2_nozero, na.rm = TRUE)      
    ~ "Severe ascites"
  )) %>% 
  mutate_at("l3midavg_ascites_hemoperitoneum_volume_cm3_ascitesgroup", ~ case_when(
    . == "No ascites"                                ~ "No ascites",
    . == "Yes ascites" &
      l3midavg_ascites_hemoperitoneum_volume_cm3 <= median(l3midavg_ascites_hemoperitoneum_volume_cm3_nozero, na.rm = TRUE)     
    ~ "Mild ascites",
    . == "Yes ascites" &
      l3midavg_ascites_hemoperitoneum_volume_cm3 > median(l3midavg_ascites_hemoperitoneum_volume_cm3_nozero, na.rm = TRUE)      
    ~ "Severe ascites"
  )) %>% 
  mutate_at("l3midavg_ascites_full_area_cm2_ascitesgroup", ~ case_when(
    . == "No ascites"                                ~ "No ascites",
    . == "Yes ascites" &
      l3midavg_ascites_full_area_cm2 <= median(l3midavg_ascites_full_area_cm2_nozero, na.rm = TRUE)     
    ~ "Mild ascites",
    . == "Yes ascites" &
      l3midavg_ascites_full_area_cm2 > median(l3midavg_ascites_full_area_cm2_nozero, na.rm = TRUE)      
    ~ "Severe ascites"
  )) %>% 
  mutate_at("l3midavg_ascites_full_volume_cm3_ascitesgroup", ~ case_when(
    . == "No ascites"                                ~ "No ascites",
    . == "Yes ascites" &
      l3midavg_ascites_full_volume_cm3 <= median(l3midavg_ascites_full_volume_cm3_nozero, na.rm = TRUE)     
    ~ "Mild ascites",
    . == "Yes ascites" &
      l3midavg_ascites_full_volume_cm3 > median(l3midavg_ascites_full_volume_cm3_nozero, na.rm = TRUE)      
    ~ "Severe ascites"
  )) %>% 
  mutate(across(c(ends_with("_ascitesgroup")),
                ~ factor(., levels =
                           c("No ascites", "Mild ascites", "Severe ascites"))))
```

### Ascites by site
```{r}
data1 %>%
  select(ends_with("_ascitesgroup"),
         site) %>%
  `colnames<-`(str_remove(colnames(.), "l3midavg_") %>%
                 str_replace(., "ascitesgroup", "(cat)") %>%
                 str_replace(., "ascites", "Ascites") %>%
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall() %>%
  modify_header(label ~ "**Ascites 3 groups <br>No(feature == 0) <br>
                Mild(feature < median zeroexcl feature) <br>
                Severe(feature > median zeroexcl feature)**",
                all_stat_cols() ~ "**{level}**, N = {n}")
```

### Ascites and survival
```{r}
tbl_uvregression(
  data1,
  method = coxph,
  y = Surv(time = os_time_from_dx_months, event = os_event),
  exponentiate = TRUE,
  include = c("l3midavg_ascites_exudative_area_cm2_ascitesgroup", "l3midavg_ascites_exudative_volume_cm3_ascitesgroup",
              "l3midavg_ascites_transudative_area_cm2_ascitesgroup", "l3midavg_ascites_transudative_volume_cm3_ascitesgroup",
              "l3midavg_ascites_hemoperitoneum_area_cm2_ascitesgroup", "l3midavg_ascites_hemoperitoneum_volume_cm3_ascitesgroup",
              "l3midavg_ascites_full_area_cm2_ascitesgroup", "l3midavg_ascites_full_volume_cm3_ascitesgroup"
              ),
  # pvalue_fun = label_style_pvalue(digits = 2)
  ) %>%
  bold_p(t = .05) %>%
  add_nevent(location = "level") %>% add_n(location = "level") %>%
  bold_labels() %>% italicize_levels()
```

```{r KM ascites cat3 group}
ggsurvplot(survfit(Surv(os_time_from_dx_months, event = os_event) ~ 
                     l3midavg_ascites_exudative_area_cm2_ascitesgroup, 
                   data = data1), 
           data = data1,
           title = "OS Analysis",
           font.main = c(20, "bold", "black"),
           font.x = c(18, "bold", "black"),
           font.y = c(18, "bold", "black"),
           font.legend = c(16, "black"),
           font.tickslab = c(16, "bold", "black"),
           size = 1,

           xlab = "Time (months)",
           legend = "top",
           legend.title = "",
           # legend.labs = c("Low", "High"),
           pval = TRUE,
           conf.int = FALSE,
           # Censor
           censor = TRUE
)
```
<br>

# IV. Survival analysis - limit to l3midavg data and actual muscle and adiposity body composition features
## 1. HR Overall
```{r HR}
tbl_1 <- tbl_uvregression(
  data,
  method = coxph,
  y = Surv(time = os_time_from_dx_months, event = os_event),
  exponentiate = TRUE,
  include = c("age_at_diagnosis", 
              "tnm_cs_mixed_group_stage", 
              "site", "debulking", 
              "raceeth", "treatment_type", "bmi_cat",
              starts_with("predx_")
              ),
  # pvalue_fun = label_style_pvalue(digits = 2)
  ) %>%
  bold_p(t = .05) %>%
  add_nevent(location = "level") %>% add_n(location = "level") %>%
  bold_labels() %>% italicize_levels()
tbl_2 <-
  coxph(Surv(time = data$os_time_from_dx_months,
             event = data$os_event) ~ age_at_diagnosis +
          tnm_cs_mixed_group_stage,
        data = data) %>%
  tbl_regression(exponentiate = TRUE) %>%
  bold_p(t = 0.05) %>%
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_3 <-
  coxph(Surv(time = data$os_time_from_dx_months,
             event = data$os_event) ~ age_at_diagnosis +
          tnm_cs_mixed_group_stage + site +
          debulking,
        data = data) %>%
  tbl_regression(exponentiate = TRUE) %>%
  bold_p(t = 0.05) %>%
  add_nevent(location = "level") %>% add_n(location = "level")

tbl_clin <- tbl_merge(list(tbl_1, tbl_2, tbl_3),
                      tab_spanner = c("**Univariable**", "**Multivariable 1**", "**Debulking**"))


tbl_sdhr <- tbl_uvregression(
  data,
  method = coxph,
  y = Surv(time = os_time_from_dx_months, event = os_event),
  exponentiate = TRUE,
  include = c("l3midavg_skm_hu_mean_sdhr", "l3midavg_myosteatosis",
              "l3midavg_skm_area_cm2_sdhr", "l3midavg_vat_area_cm2_sdhr", 
              "l3midavg_sat_area_cm2_sdhr", "l3midavg_imat_area_cm2_sdhr",
              "l3midavg_skm_volume_cm3_sdhr", "l3midavg_vat_volume_cm3_sdhr", 
              "l3midavg_sat_volume_cm3_sdhr", "l3midavg_imat_volume_cm3_sdhr"
              ),
  # pvalue_fun = label_style_pvalue(digits = 2)
  ) %>%
  bold_p(t = .05) %>%
  add_nevent(location = "level") %>% add_n(location = "level") %>%
  bold_labels() %>% italicize_levels()


tbl_raw <- tbl_uvregression(
  data,
  method = coxph,
  y = Surv(time = os_time_from_dx_months, event = os_event),
  exponentiate = TRUE,
  include = c("l3midavg_skm_hu_mean",
              "l3midavg_skm_area_cm2", "l3midavg_vat_area_cm2", 
              "l3midavg_sat_area_cm2", "l3midavg_imat_area_cm2",
              "l3midavg_skm_volume_cm3", "l3midavg_vat_volume_cm3", 
              "l3midavg_sat_volume_cm3", "l3midavg_imat_volume_cm3",
              "l3midavg_v_s_ratio_cm2", "l3midavg_v_s_ratio_cm3",
              "l3midavg_tat_cm2", "l3midavg_tat_cm3"
              ),
  # pvalue_fun = label_style_pvalue(digits = 2)
  ) %>%
  bold_p(t = .05) %>%
  add_nevent(location = "level") %>% add_n(location = "level") %>%
  bold_labels() %>% italicize_levels()

tbl_index <- tbl_uvregression(
  data,
  method = coxph,
  y = Surv(time = os_time_from_dx_months, event = os_event),
  exponentiate = TRUE,
  include = c("l3midavg_smi", "l3midavg_sarcopenia",
              "l3midavg_sat_area_cm2_index", "l3midavg_vat_area_cm2_index", 
              "l3midavg_imat_area_cm2_index",
              "l3midavg_skm_volume_cm3_index", "l3midavg_sat_volume_cm3_index", 
              "l3midavg_vat_volume_cm3_index", "l3midavg_imat_volume_cm3_index"
              ),
  # pvalue_fun = label_style_pvalue(digits = 2)
  ) %>%
  bold_p(t = .05) %>%
  add_nevent(location = "level") %>% add_n(location = "level") %>%
  bold_labels() %>% italicize_levels()

tbl_prop <- tbl_uvregression(
  data,
  method = coxph,
  y = Surv(time = os_time_from_dx_months, event = os_event),
  exponentiate = TRUE,
  include = c("l3midavg_muscle_proportion_cm2", "l3midavg_sat_proportion_cm2", 
              "l3midavg_vat_proportion_cm2", "l3midavg_imat_proportion_cm2",
              "l3midavg_muscle_proportion_cm3", "l3midavg_sat_proportion_cm3", 
              "l3midavg_vat_proportion_cm3", "l3midavg_imat_proportion_cm3"
              ),
  # pvalue_fun = label_style_pvalue(digits = 2)
  ) %>%
  bold_p(t = .05) %>%
  add_nevent(location = "level") %>% add_n(location = "level") %>%
  bold_labels() %>% italicize_levels()

tbl_cat <- tbl_uvregression(
  data,
  method = coxph,
  y = Surv(time = os_time_from_dx_months, event = os_event),
  exponentiate = TRUE,
  include = c("ascites_cutpoint_cat",
              starts_with("l3midavg_") & ends_with("_tertcat")
              ),
  # pvalue_fun = label_style_pvalue(digits = 2)
  ) %>%
  bold_p(t = .05) %>%
  add_nevent(location = "level") %>% add_n(location = "level") %>%
  bold_labels() %>% italicize_levels()

# print("PH assumption")
# coxph(Surv(time = data$os_time_from_dx_months,
#              event = data$os_event) ~ age_at_diagnosis + tnm_cs_mixed_group_stage + debulking,
#         data =  data)  %>%
#   cox.zph()
```

```{r gt HR survival}
merge_tbl <- tbl_stack(list(tbl_1, tbl_sdhr, tbl_raw, tbl_index, tbl_prop, tbl_cat)#, 
                    # group_header = c("Clinical", "1-SD normalized features",
                    #                  "Raw features", "Indexed features", 
                    #                  "Tissue proportion",
                    #                  "ALL categorical")
                    )

gt_tbl <-
  tbl_merge(list(merge_tbl, tbl_2, tbl_3), 
                    tab_spanner = c("**Univariable**", "**Multivariable 1**", "**Debulking**")) %>%
  # add_variable_group_header(
  #   header = "Clinical",
  #   variables = "age_at_diagnosis",
  #   indent = 0
  # )|>
  #   add_variable_group_header(
  #   header = "1-SD normalized features",
  #   variables = "l3midavg_skm_hu_mean_sdhr",
  #   indent = 0
  # )|>
  #   add_variable_group_header(
  #   header = "Raw features",
  #   variables = "l3midavg_skm_hu_mean",
  #   indent = 0
  # )|>
  #   add_variable_group_header(
  #   header = "Indexed features",
  #   variables = "l3midavg_smi",
  #   indent = 0
  # )|>
  #   add_variable_group_header(
  #   header = "Tissue proportion",
  #   variables = "l3midavg_muscle_proportion_cm2",
  #   indent = 0
  # )|>
  #   add_variable_group_header(
  #   header = "ALL categorical",
  #   variables = "ascites_cutpoint_cat",
  #   indent = 0
  # ) %>% 
  # modify_table_body(
  #   mutate,
  #   groupname_col = case_when(variable %in% c("age_at_diagnosis", "predx_diabetes") ~ "Deomgraphics",
  #                             variable == "l3midavg_myosteatosis" ~ "Tumor Characteristics")
  # )
  as_gt(rownames_to_stub = TRUE
  ) %>%
  gt::tab_options(row_group.border.top.color = "black",
                  row_group.border.top.width = 3,
                  row_group.border.bottom.color = "darkgrey",
                  row_group.font.size = 15,
                  row_group.font.weight = "bold",
                  row_group.text_transform = "uppercase",
                  row_group.background.color = "grey")
gt_tbl %>% 
    tab_row_group(
    label = "ALL categorical", rows = 86:204
  ) %>% 
    tab_row_group(
    label = "Tissue proportion", rows = 78:85
  ) %>% 
    tab_row_group(
    label = "Indexed features", rows = 71:77
  ) %>% 
    tab_row_group(
    label = "Raw features", rows = 54:70
  ) %>% 
  tab_row_group(
    label = "1-SD normalized features", rows = 42:53
  ) %>% 
  tab_row_group(
    label = "Clinical", rows = 1:41
  )
  # data_color(
  #   columns = everything(),
  #   rows = 1:20,
  #   # rows = ends_with("SMI"),
  #   palette = "lightblue", na_color = "lightblue"
  # ) %>%
  # data_color(
  #   columns = everything(),
  #   rows = 41:50,
  #   # rows = ends_with("SMI"),
  #   palette = "lightblue", na_color = "lightblue"
  # ) %>%
  # data_color(
  #   columns = everything(),
  #   rows = 56:60,
  #   # rows = ends_with("SMI"),
  #   palette = "lightblue", na_color = "lightblue"
  # ) %>%
  # data_color(
  #   columns = everything(),
  #   rows = 66:85,
  #   # rows = ends_with("SMI"),
  #   palette = "lightblue", na_color = "lightblue"
  # ) %>%
  # data_color(
  #   columns = everything(),
  #   rows = 106:125,
  #   # rows = ends_with("SMI"),
  #   palette = "lightblue", na_color = "lightblue"
  # )
```

## 2. Startitied by first line therapy
```{r Stratified treatment}
data_neo <- data %>%
  filter(treatment_type == "Upfront chemo")

data_surg <- data %>%
  filter(treatment_type == "Upfront surgery")
```


### Upfront Chemo
```{r HR chemo}
# table(data_neo$l3midavg_sarcopenia, data_neo$os_event)
# print("there is only 1 level for sarcopenia. Exclude from the model.")
tbl_1 <- tbl_uvregression(
  data_neo,
  method = coxph,
  y = Surv(time = os_time_from_dx_months, event = os_event),
  exponentiate = TRUE,
  include = c("age_at_diagnosis", 
              "tnm_cs_mixed_group_stage", 
              "site", "debulking", 
              "raceeth", "bmi_cat",
              starts_with("predx_"),
              "l3midavg_skm_hu_mean_sdhr", "l3midavg_myosteatosis",
              "l3midavg_skm_area_cm2_sdhr", "l3midavg_vat_area_cm2_sdhr", 
              "l3midavg_sat_area_cm2_sdhr", "l3midavg_imat_area_cm2_sdhr",
              "l3midavg_skm_volume_cm3_sdhr", "l3midavg_vat_volume_cm3_sdhr", 
              "l3midavg_sat_volume_cm3_sdhr", "l3midavg_imat_volume_cm3_sdhr",
              "l3midavg_skm_hu_mean",
              "l3midavg_skm_area_cm2", "l3midavg_vat_area_cm2", 
              "l3midavg_sat_area_cm2", "l3midavg_imat_area_cm2",
              "l3midavg_skm_volume_cm3", "l3midavg_vat_volume_cm3", 
              "l3midavg_sat_volume_cm3", "l3midavg_imat_volume_cm3",
              "l3midavg_v_s_ratio_cm2", "l3midavg_v_s_ratio_cm3",
              "l3midavg_tat_cm2", "l3midavg_tat_cm3",
              "l3midavg_smi", "l3midavg_sarcopenia",
              "l3midavg_sat_area_cm2_index", "l3midavg_vat_area_cm2_index", 
              "l3midavg_imat_area_cm2_index",
              "l3midavg_skm_volume_cm3_index", "l3midavg_sat_volume_cm3_index", 
              "l3midavg_vat_volume_cm3_index", "l3midavg_imat_volume_cm3_index",
              "l3midavg_muscle_proportion_cm2", "l3midavg_sat_proportion_cm2", 
              "l3midavg_vat_proportion_cm2", "l3midavg_imat_proportion_cm2",
              "l3midavg_muscle_proportion_cm3", "l3midavg_sat_proportion_cm3", 
              "l3midavg_vat_proportion_cm3", "l3midavg_imat_proportion_cm3",
              "ascites_cutpoint_cat",
              starts_with("l3midavg_") & ends_with("_tertcat")),
  # pvalue_fun = label_style_pvalue(digits = 2)
) %>%
  bold_p(t = .05) %>%
  add_nevent(location = "level") %>% add_n(location = "level") %>%
  bold_labels() %>% italicize_levels()
tbl_2 <-
  coxph(Surv(time = data_neo$os_time_from_dx_months,
             event = data_neo$os_event) ~ age_at_diagnosis +
          tnm_cs_mixed_group_stage +
          debulking,
        data = data_neo) %>%
  tbl_regression(exponentiate = TRUE) %>%
  bold_p(t = 0.05) %>%
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_3 <-
  coxph(Surv(time = data_neo$os_time_from_dx_months,
             event = data_neo$os_event) ~ age_at_diagnosis +
          tnm_cs_mixed_group_stage + site +
          debulking,
        data = data_neo) %>%
  tbl_regression(exponentiate = TRUE) %>%
  bold_p(t = 0.05) %>%
  add_nevent(location = "level") %>% add_n(location = "level")

tbl_merge(list(tbl_1, tbl_2, tbl_3), tab_spanner = c("**Univariable**", "**Multivariable 1**", "**Debulking**"))
```

### Upfront Surgery
```{r HR surg}
# table(data_surg$l3midavg_sarcopenia, data_surg$os_event)
tbl_1 <- tbl_uvregression(
  data_surg,
  method = coxph,
  y = Surv(time = os_time_from_dx_months, event = os_event),
  exponentiate = TRUE,
  include = c("age_at_diagnosis", 
              "tnm_cs_mixed_group_stage", 
              "site", "debulking", 
              "raceeth", "bmi_cat",
              starts_with("predx_"),
              "l3midavg_skm_hu_mean_sdhr", "l3midavg_myosteatosis",
              "l3midavg_skm_area_cm2_sdhr", "l3midavg_vat_area_cm2_sdhr", 
              "l3midavg_sat_area_cm2_sdhr", "l3midavg_imat_area_cm2_sdhr",
              "l3midavg_skm_volume_cm3_sdhr", "l3midavg_vat_volume_cm3_sdhr", 
              "l3midavg_sat_volume_cm3_sdhr", "l3midavg_imat_volume_cm3_sdhr",
              "l3midavg_skm_hu_mean",
              "l3midavg_skm_area_cm2", "l3midavg_vat_area_cm2", 
              "l3midavg_sat_area_cm2", "l3midavg_imat_area_cm2",
              "l3midavg_skm_volume_cm3", "l3midavg_vat_volume_cm3", 
              "l3midavg_sat_volume_cm3", "l3midavg_imat_volume_cm3",
              "l3midavg_v_s_ratio_cm2", "l3midavg_v_s_ratio_cm3",
              "l3midavg_tat_cm2", "l3midavg_tat_cm3",
              "l3midavg_smi", "l3midavg_sarcopenia",
              "l3midavg_sat_area_cm2_index", "l3midavg_vat_area_cm2_index", 
              "l3midavg_imat_area_cm2_index",
              "l3midavg_skm_volume_cm3_index", "l3midavg_sat_volume_cm3_index", 
              "l3midavg_vat_volume_cm3_index", "l3midavg_imat_volume_cm3_index",
              "l3midavg_muscle_proportion_cm2", "l3midavg_sat_proportion_cm2", 
              "l3midavg_vat_proportion_cm2", "l3midavg_imat_proportion_cm2",
              "l3midavg_muscle_proportion_cm3", "l3midavg_sat_proportion_cm3", 
              "l3midavg_vat_proportion_cm3", "l3midavg_imat_proportion_cm3",
              "ascites_cutpoint_cat",
              starts_with("l3midavg_") & ends_with("_tertcat")),
  # pvalue_fun = label_style_pvalue(digits = 2)
) %>%
  bold_p(t = .05) %>%
  add_nevent(location = "level") %>% add_n(location = "level") %>%
  bold_labels() %>% italicize_levels()
tbl_2 <-
  coxph(Surv(time = data_surg$os_time_from_dx_months,
             event = data_surg$os_event) ~ age_at_diagnosis +
          tnm_cs_mixed_group_stage,
        data = data_surg) %>%
  tbl_regression(exponentiate = TRUE) %>%
  bold_p(t = 0.05) %>%
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_3 <-
  coxph(Surv(time = data_surg$os_time_from_dx_months,
             event = data_surg$os_event) ~ age_at_diagnosis +
          tnm_cs_mixed_group_stage + site +
          debulking,
        data = data_surg) %>%
  tbl_regression(exponentiate = TRUE) %>%
  bold_p(t = 0.05) %>%
  add_nevent(location = "level") %>% add_n(location = "level")

tbl_merge(list(tbl_1, tbl_2, tbl_3), tab_spanner = c("**Univariable**", "**Multivariable 1**", "**Debulking**"))
```

## 2. Startitied by Sarcopenia presence in L3 migavg region
```{r Stratified Sarcopenia}
data_sarcopenia <- data %>%
  filter(l3midavg_sarcopenia == "<38.5 : sarcopenia")

data_asc_absence <- data %>%
  filter(l3midavg_sarcopenia == "≥38.5")
```

### Presence Sarcopenia
```{r HR stratified yes sarcopenia}
tbl_1 <- tbl_uvregression(
  data_sarcopenia,
  method = coxph,
  y = Surv(time = os_time_from_dx_months, event = os_event),
  exponentiate = TRUE,
  include = c("age_at_diagnosis", 
              "tnm_cs_mixed_group_stage", 
              "site", "debulking", 
              "raceeth", "treatment_type", "bmi_cat",
              starts_with("predx_"),
              "l3midavg_skm_hu_mean_sdhr", "l3midavg_myosteatosis",
              "l3midavg_skm_area_cm2_sdhr", "l3midavg_vat_area_cm2_sdhr", 
              "l3midavg_sat_area_cm2_sdhr", "l3midavg_imat_area_cm2_sdhr",
              "l3midavg_skm_volume_cm3_sdhr", "l3midavg_vat_volume_cm3_sdhr", 
              "l3midavg_sat_volume_cm3_sdhr", "l3midavg_imat_volume_cm3_sdhr",
              "l3midavg_skm_hu_mean",
              "l3midavg_skm_area_cm2", "l3midavg_vat_area_cm2", 
              "l3midavg_sat_area_cm2", "l3midavg_imat_area_cm2",
              "l3midavg_skm_volume_cm3", "l3midavg_vat_volume_cm3", 
              "l3midavg_sat_volume_cm3", "l3midavg_imat_volume_cm3",
              "l3midavg_v_s_ratio_cm2", "l3midavg_v_s_ratio_cm3",
              "l3midavg_tat_cm2", "l3midavg_tat_cm3",
              "l3midavg_smi", 
              "l3midavg_sat_area_cm2_index", "l3midavg_vat_area_cm2_index", 
              "l3midavg_imat_area_cm2_index",
              "l3midavg_skm_volume_cm3_index", "l3midavg_sat_volume_cm3_index", 
              "l3midavg_vat_volume_cm3_index", "l3midavg_imat_volume_cm3_index",
              "l3midavg_muscle_proportion_cm2", "l3midavg_sat_proportion_cm2", 
              "l3midavg_vat_proportion_cm2", "l3midavg_imat_proportion_cm2",
              "l3midavg_muscle_proportion_cm3", "l3midavg_sat_proportion_cm3", 
              "l3midavg_vat_proportion_cm3", "l3midavg_imat_proportion_cm3",
              "ascites_cutpoint_cat",
              starts_with("l3midavg_") & ends_with("_tertcat")),
  # pvalue_fun = label_style_pvalue(digits = 2)
) %>%
  bold_p(t = .05) %>%
  add_nevent(location = "level") %>% add_n(location = "level") %>%
  bold_labels() %>% italicize_levels()
tbl_2 <-
  coxph(Surv(time = data_sarcopenia$os_time_from_dx_months,
             event = data_sarcopenia$os_event) ~ age_at_diagnosis +
          tnm_cs_mixed_group_stage,
        data = data_sarcopenia) %>%
  tbl_regression(exponentiate = TRUE) %>%
  bold_p(t = 0.05) %>%
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_3 <-
  coxph(Surv(time = data_sarcopenia$os_time_from_dx_months,
             event = data_sarcopenia$os_event) ~ age_at_diagnosis +
          tnm_cs_mixed_group_stage + site +
          debulking,
        data = data_sarcopenia) %>%
  tbl_regression(exponentiate = TRUE) %>%
  bold_p(t = 0.05) %>%
  add_nevent(location = "level") %>% add_n(location = "level")

tbl_merge(list(tbl_1, tbl_2, tbl_3), tab_spanner = c("**Univariable**", "**Multivariable 1**", "**Debulking**"))
```

### Absence Sarcopenia
```{r HR stratified no sarcopenia}
tbl_1 <- tbl_uvregression(
  data_asc_absence,
  method = coxph,
  y = Surv(time = os_time_from_dx_months, event = os_event),
  exponentiate = TRUE,
  include = c("age_at_diagnosis", 
              "tnm_cs_mixed_group_stage", 
              "site", "debulking", 
              "raceeth", "treatment_type", "bmi_cat",
              starts_with("predx_"),
              "l3midavg_skm_hu_mean_sdhr", "l3midavg_myosteatosis",
              "l3midavg_skm_area_cm2_sdhr", "l3midavg_vat_area_cm2_sdhr", 
              "l3midavg_sat_area_cm2_sdhr", "l3midavg_imat_area_cm2_sdhr",
              "l3midavg_skm_volume_cm3_sdhr", "l3midavg_vat_volume_cm3_sdhr", 
              "l3midavg_sat_volume_cm3_sdhr", "l3midavg_imat_volume_cm3_sdhr",
              "l3midavg_skm_hu_mean",
              "l3midavg_skm_area_cm2", "l3midavg_vat_area_cm2", 
              "l3midavg_sat_area_cm2", "l3midavg_imat_area_cm2",
              "l3midavg_skm_volume_cm3", "l3midavg_vat_volume_cm3", 
              "l3midavg_sat_volume_cm3", "l3midavg_imat_volume_cm3",
              "l3midavg_v_s_ratio_cm2", "l3midavg_v_s_ratio_cm3",
              "l3midavg_tat_cm2", "l3midavg_tat_cm3",
              "l3midavg_smi", 
              "l3midavg_sat_area_cm2_index", "l3midavg_vat_area_cm2_index", 
              "l3midavg_imat_area_cm2_index",
              "l3midavg_skm_volume_cm3_index", "l3midavg_sat_volume_cm3_index", 
              "l3midavg_vat_volume_cm3_index", "l3midavg_imat_volume_cm3_index",
              "l3midavg_muscle_proportion_cm2", "l3midavg_sat_proportion_cm2", 
              "l3midavg_vat_proportion_cm2", "l3midavg_imat_proportion_cm2",
              "l3midavg_muscle_proportion_cm3", "l3midavg_sat_proportion_cm3", 
              "l3midavg_vat_proportion_cm3", "l3midavg_imat_proportion_cm3",
              "ascites_cutpoint_cat",
              starts_with("l3midavg_") & ends_with("_tertcat")),
  # pvalue_fun = label_style_pvalue(digits = 2)
) %>%
  bold_p(t = .05) %>%
  add_nevent(location = "level") %>% add_n(location = "level") %>%
  bold_labels() %>% italicize_levels()

tbl_2 <-
  coxph(Surv(time = data_asc_absence$os_time_from_dx_months,
             event = data_asc_absence$os_event) ~ age_at_diagnosis +
          tnm_cs_mixed_group_stage,
        data = data_asc_absence) %>%
  tbl_regression(exponentiate = TRUE) %>%
  bold_p(t = 0.05) %>%
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_3 <-
  coxph(Surv(time = data_asc_absence$os_time_from_dx_months,
             event = data_asc_absence$os_event) ~ age_at_diagnosis +
          tnm_cs_mixed_group_stage + site +
          debulking,
        data = data_asc_absence) %>%
  tbl_regression(exponentiate = TRUE) %>%
  bold_p(t = 0.05) %>%
  add_nevent(location = "level") %>% add_n(location = "level")

tbl_merge(list(tbl_1, tbl_2, tbl_3), tab_spanner = c("**Univariable**", "**Multivariable 1**", "**Debulking**"))
```

# V. Roswell analyses
## 1. Phenotype categories
"As no standard cut-points for adiposity at L3 exist, and tertile 1 coincided with the approximate percentage of normal-weight patients in our cohort according to BMI, we used the cut-point for the lowest tertile of adiposity to classify low vs high adiposity. Next, adiposity and muscle joint-exposure body composition phenotypes were classified as fit (normal SMI and low adiposity); overweight or obese (normal SMI and high adiposity); sarcopenia and overweight or obese (low SMI and high adiposity); and sarcopenia or cachexia (low SMI and low adiposity)." Evan's paper.
Hazard of all-cause mortality was the primary analytic outcome, an excellent proxy for EOC-specific mortality.

```{r code roswell phenotype}
data <- data %>%
  mutate(imat_phenotype = case_when(
    l3midavg_sarcopenia == "≥38.5" &
      l3midavg_imat_area_cm2_tertcat == "Low"             ~ "Normal SMI / Low IMAT",
    l3midavg_sarcopenia == "≥38.5" &
      !is.na(l3midavg_imat_area_cm2_tertcat)              ~ "Normal SMI / High IMAT",
    l3midavg_sarcopenia == "<38.5 : sarcopenia" &
      l3midavg_imat_area_cm2_tertcat == "Low"             ~ "Low SMI / Low IMAT",
    l3midavg_sarcopenia == "<38.5 : sarcopenia" &
      !is.na(l3midavg_imat_area_cm2_tertcat)              ~ "Low SMI / High IMAT"
  ), imat_phenotype = relevel(factor(imat_phenotype), ref = "Normal SMI / Low IMAT")) %>%
  mutate(sat_phenotype = case_when(
    l3midavg_sarcopenia == "≥38.5" &
      l3midavg_sat_area_cm2_tertcat == "Low"              ~ "Normal SMI / Low SAT",
    l3midavg_sarcopenia == "≥38.5" &
      !is.na(l3midavg_sat_area_cm2_tertcat)               ~ "Normal SMI / High SAT",
    l3midavg_sarcopenia == "<38.5 : sarcopenia" &
      l3midavg_sat_area_cm2_tertcat == "Low"              ~ "Low SMI / Low SAT",
    l3midavg_sarcopenia == "<38.5 : sarcopenia" &
      !is.na(l3midavg_sat_area_cm2_tertcat)               ~ "Low SMI / High SAT"
  ), sat_phenotype = relevel(factor(sat_phenotype), ref = "Normal SMI / Low SAT")) %>%
  mutate(vat_phenotype = case_when(
    l3midavg_sarcopenia == "≥38.5" &
      l3midavg_vat_area_cm2_tertcat == "Low"              ~ "Normal SMI / Low VAT",
    l3midavg_sarcopenia == "≥38.5" &
      !is.na(l3midavg_vat_area_cm2_tertcat)               ~ "Normal SMI / High VAT",
    l3midavg_sarcopenia == "<38.5 : sarcopenia" &
      l3midavg_vat_area_cm2_tertcat == "Low"              ~ "Low SMI / Low VAT",
    l3midavg_sarcopenia == "<38.5 : sarcopenia" &
      !is.na(l3midavg_vat_area_cm2_tertcat)               ~ "Low SMI / High VAT"
  ), vat_phenotype = relevel(factor(vat_phenotype), ref = "Normal SMI / Low VAT")) %>%
  mutate(tat_phenotype = case_when(
    l3midavg_sarcopenia == "≥38.5" &
      l3midavg_tat_cm2_tertcat == "Low"                   ~ "Normal SMI / Low TAT",
    l3midavg_sarcopenia == "≥38.5" &
      !is.na(l3midavg_tat_cm2_tertcat)                    ~ "Normal SMI / High TAT",
    l3midavg_sarcopenia == "<38.5 : sarcopenia" &
      l3midavg_tat_cm2_tertcat == "Low"                   ~ "Low SMI / Low TAT",
    l3midavg_sarcopenia == "<38.5 : sarcopenia" &
      !is.na(l3midavg_tat_cm2_tertcat)                    ~ "Low SMI / High TAT"
  ), tat_phenotype = relevel(factor(tat_phenotype), ref = "Normal SMI / Low TAT"))
```

### Table
```{r roswell table}
data %>%
  select(contains("_phenotype"),
         site) %>%
  `colnames<-`(str_replace(colnames(.), "tat", "TAT") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = site) %>%
  bold_labels() %>%
  add_p() %>% bold_p() %>% add_overall() %>%
  modify_header(label ~ "**DAFS**",
                all_stat_cols() ~ "**{level}**, N = {n}")
data %>%
  select(contains("_phenotype"),
         raceeth) %>%
  `colnames<-`(str_replace(colnames(.), "tat", "TAT") %>%
                 str_replace(., "sat", "SAT") %>%
                 str_replace(., "vat", "VAT") %>%
                 str_replace(., "imat", "IMAT") %>%
                 str_replace_all(., "_", " ")) %>%
  tbl_summary(by = raceeth) %>%
  bold_labels() %>%
  add_p(test.args = all_tests("fisher.test") ~ list(workspace=2e9)) %>% bold_p() %>% add_overall() %>%
  modify_header(label ~ "**DAFS**",
                all_stat_cols() ~ "**{level}**, N = {n}")
```

### HR
```{r}
tbl_1 <- tbl_uvregression(
  data,
  method = coxph,
  y = Surv(time = os_time_from_dx_months, event = os_event),
  exponentiate = TRUE,
  include = c("age_at_diagnosis", "raceeth", "bmi_cat",
              "tnm_cs_mixed_group_stage", "treatment_type",
              "debulking", "site",
              "imat_phenotype", "sat_phenotype",
              "vat_phenotype", "tat_phenotype",
              "ascites_cutpoint_cat"),
  # pvalue_fun = label_style_pvalue(digits = 2)
  ) %>%
  bold_p(t = .05) %>%
  add_nevent(location = "level") %>% add_n(location = "level") %>%
  bold_labels() %>% italicize_levels()

tbl_2 <-
  coxph(Surv(time = data$os_time_from_dx_months,
             event = data$os_event) ~ age_at_diagnosis +
          tnm_cs_mixed_group_stage +
          debulking + imat_phenotype + sat_phenotype + vat_phenotype + tat_phenotype,
        data = data) %>%
  tbl_regression(exponentiate = TRUE) %>%
  bold_p(t = 0.05) %>%
  add_nevent(location = "level") %>% add_n(location = "level")

# tbl_3 <-
#   coxph(Surv(time = data$os_time_from_dx_months,
#              event = data$os_event) ~ age_at_diagnosis +
#           tnm_cs_mixed_group_stage +
#           debulking + imat_phenotype + sat_phenotype + vat_phenotype + tat_phenotype +
#           ascites_cutpoint_cat,
#         data = data) %>%
#   tbl_regression(exponentiate = TRUE) %>%
#   bold_p(t = 0.05) %>%
#   add_nevent(location = "level") %>% add_n(location = "level")

tbl_merge(list(tbl_1, tbl_2), tab_spanner = c("**Univariable**", "**Multivariable All phenotypes**"))
```

```{r}
tbl_1 <-
  coxph(Surv(time = data$os_time_from_dx_months,
             event = data$os_event) ~ age_at_diagnosis +
          tnm_cs_mixed_group_stage +
          debulking + imat_phenotype,
        data = data) %>%
  tbl_regression(exponentiate = TRUE) %>%
  bold_p(t = 0.05) %>%
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_2 <-
  coxph(Surv(time = data$os_time_from_dx_months,
             event = data$os_event) ~ age_at_diagnosis +
          tnm_cs_mixed_group_stage +
          debulking + sat_phenotype,
        data = data) %>%
  tbl_regression(exponentiate = TRUE) %>%
  bold_p(t = 0.05) %>%
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_3 <-
  coxph(Surv(time = data$os_time_from_dx_months,
             event = data$os_event) ~ age_at_diagnosis +
          tnm_cs_mixed_group_stage +
          debulking + vat_phenotype,
        data = data) %>%
  tbl_regression(exponentiate = TRUE) %>%
  bold_p(t = 0.05) %>%
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_4 <-
  coxph(Surv(time = data$os_time_from_dx_months,
             event = data$os_event) ~ age_at_diagnosis +
          tnm_cs_mixed_group_stage +
          debulking + tat_phenotype,
        data = data) %>%
  tbl_regression(exponentiate = TRUE) %>%
  bold_p(t = 0.05) %>%
  add_nevent(location = "level") %>% add_n(location = "level")

tbl_merge(list(tbl_1, tbl_2, tbl_3, tbl_4), tab_spanner = c("**IMAT**", "**SAT**", "**VAT**", "**TAT**")
          )
```

## 2. BCI?













<br>

***

sessionInfo available in Readme file

```{r}
sessionInfo() %>% capture.output(file="readme_sessioninfo_overall_analysis.txt")
```









